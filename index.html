<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Waleed Designs - مُحاكي تصميم غرف النوم</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Cairo Font for Arabic (Inter for English) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-32MKV2L3P1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-32MKV2L3P1');
    </script>
    <!-- html2pdf.js for modern PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tnomnj0qq1");
    </script>
    <style>
        /* Custom styles to ensure proper Arabic typography and flow */
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind's slate-50 */
        }
        /* Style adjustments for LTR mode (English) */
        body[dir="ltr"] {
            font-family: 'Inter', 'Cairo', sans-serif;
        }
        
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Custom Modal Styles */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        /* Custom Checkbox Styles */
        .custom-checkbox:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        
        /* Highlight Class for momentary visual feedback */
        .highlight-flash {
            animation: highlight-bg 0.7s ease-out;
        }
        @keyframes highlight-bg {
            0% { background-color: #e0e7ff; } /* Indigo-100 */
            100% { background-color: transparent; }
        }
        
        /* Tooltip Styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip-trigger {
            color: #4f46e5; /* Indigo */
            font-weight: bold;
            border: 1px solid #c7d2fe; /* Lighter Indigo */
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin-right: 5px; /* RTL margin */
        }
        body[dir="ltr"] .tooltip-trigger {
            margin-left: 5px; /* LTR margin */
            margin-right: 0;
        }
        .tooltip-content {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937; /* Gray-800 */
            color: #fff;
            text-align: right;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the trigger */
            right: 50%;
            margin-right: -140px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
            line-height: 1.6;
        }
        body[dir="ltr"] .tooltip-content {
            text-align: left;
            left: 50%;
            right: auto;
            margin-left: -140px;
            margin-right: 0;
        }
        .tooltip-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        .input-error-message {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: #ef4444; /* Red-500 */
            height: 1.25rem; /* Reserve space to prevent layout shift */
        }
        @keyframes pulse-shadow {
          0%, 100% {
            box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4);
          }
          70% {
            box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
          }
        }
        .animate-pulse-shadow {
            animation: pulse-shadow 2.5s infinite;
        }
        .mechanism-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #4f46e5;
            font-weight: bold;
        }
        .mechanism-btn:not(.active) {
            background-color: #ffffff;
            color: #334155; /* slate-700 */
            border-color: #cbd5e1; /* slate-300 */
        }
        .mechanism-btn:not(.active):hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Number input stepper styles */
        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .stepper-container {
            display: flex;
            align-items: stretch;
        }
        .stepper-container input[type="number"] {
            border-right-width: 0;
            border-radius: 0 0.375rem 0.375rem 0; /* RTL default */
            flex-grow: 1;
            width: 0; /* Let flexbox handle width */
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
        }
        body[dir="ltr"] .stepper-container input[type="number"] {
            border-right-width: 1px;
            border-left-width: 0;
            border-radius: 0.375rem 0 0 0.375rem;
        }
        .stepper-buttons {
            display: flex;
            flex-direction: column;
        }
        .stepper-btn-v {
            width: 2rem;
            flex-grow: 1;
            background-color: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
            font-size: 1.25rem;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .stepper-btn-v:hover { background-color: #e2e8f0; }

        /* RTL buttons */
        .stepper-btn-v:first-child { /* + button on top */
            border-radius: 0.375rem 0 0 0;
            border-bottom-width: 0.5px;
        }
        .stepper-btn-v:last-child { /* - button on bottom */
            border-radius: 0 0 0 0.375rem;
            border-top-width: 0.5px;
        }

        /* LTR buttons */
        body[dir="ltr"] .stepper-btn-v:first-child {
            border-radius: 0 0.375rem 0 0;
        }
        body[dir="ltr"] .stepper-btn-v:last-child {
            border-radius: 0 0 0.375rem;
        }
    </style>
</head>
<body class="bg-slate-50">

    <div class="max-w-4xl mx-auto p-4 sm:p-6 pb-40"> <!-- Added padding-bottom for sticky footer -->
        
        <!-- HEADER -->
        <header class="mb-8 border-b-2 border-indigo-200 pb-6 relative flex justify-center items-center">
            <div class="absolute start-0 top-1/2 -translate-y-1/2">
                <button id="lang-toggle-btn" class="text-indigo-600 hover:text-indigo-800 font-bold p-1 sm:p-2 rounded-lg transition text-xs sm:text-sm border border-indigo-300 bg-white/50 hover:bg-white flex items-center gap-2">
                    <!-- English Flag (UK) -->
                    <svg id="icon-lang-en" xmlns="http://www.w3.org/2000/svg" width="20" height="15" viewBox="0 0 60 30" class="hidden">
                        <rect width="60" height="30" fill="#012169"/>
                        <path d="M0,0 L60,30 M60,0 L0,30" stroke="#FFFFFF" stroke-width="6"/>
                        <path d="M0,0 L60,30 M60,0 L0,30" stroke="#C8102E" stroke-width="4"/>
                        <path d="M30,0 V30 M0,15 H60" stroke="#FFFFFF" stroke-width="10"/>
                        <path d="M30,0 V30 M0,15 H60" stroke="#C8102E" stroke-width="6"/>
                    </svg>
                    <!-- Arabic Flag (Egypt) -->
                    <svg id="icon-lang-ar" xmlns="http://www.w3.org/2000/svg" width="20" height="15" viewBox="0 0 900 600" class="hidden">
                        <rect width="900" height="200" y="0" fill="#ce1126"/>
                        <rect width="900" height="200" y="200" fill="#fff"/>
                        <rect width="900" height="200" y="400" fill="#000"/>
                        <g transform="translate(450 300) scale(1.7)" fill="#c09300">
                            <path d="M-19.43 1.12c-3.13-1.25-11.43-1.12-11.43-1.12s-1.88-3.75-1.88-6.25c0-12.5 13.13-10.62 13.13-10.62s3.13-2.5 6.25-2.5 6.25 2.5 6.25 2.5 13.13-1.88 13.13 10.62c0 2.5-1.88 6.25-1.88 6.25s-8.3 0-11.43 1.12c-3.13 1.25-3.13 6.25-3.13 6.25s0-5-3.13-6.25z"/>
                            <path d="M-11.25 10.13h22.5v3.75h-22.5z"/>
                        </g>
                    </svg>
                    <span id="current-lang-text">English</span>
                </button>
            </div>
            <div class="text-center">
                <h1 id="header-title" class="text-4xl sm:text-5xl font-black text-indigo-800">Waleed Designs</h1>
                <p id="header-subtitle" data-lang-key="header_subtitle" class="text-lg text-slate-600 mt-2">محاكي الأسعار التفاعلي</p>
                 <div class="mt-4 flex flex-wrap justify-center items-center gap-x-4 gap-y-2">
                    <button type="button" id="show-guide-btn" class="text-indigo-600 font-bold hover:underline flex items-center gap-2 text-sm md:text-base">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-help-circle"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                        <span id="guide-button-text" data-lang-key="guide_button_text">دليل الاستخدام</span>
                    </button>
                    <button type="button" id="reset-form-btn" class="text-red-600 font-bold hover:underline flex items-center gap-2 text-sm md:text-base p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw"><path d="M21 2v6h-6"/><path d="M21.17 12a10 10 0 1 1-3.97-8.36"/></svg>
                        <span id="reset-button-text" data-lang-key="reset_button_text">إعادة تعيين</span>
                    </button>
                </div>
            </div>
        </header>
        
        <div id="main-view">

            <!-- CONFIGURATOR FORM -->
            <form id="configurator-form" class="space-y-8">
                
                <!-- Room Size Card -->
                <div class="bg-indigo-100 p-6 rounded-2xl border-2 border-indigo-300 shadow-lg">
                    <h3 id="room-size-title" class="text-2xl font-bold mb-4 text-indigo-800 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 21-6-6m6 6v-4.5m0 4.5h-4.5"/><path d="M3 3h7v7H3z"/><path d="M14 3h7v7h-7z"/><path d="M3 14h7v7H3z"/></svg>
                        <span data-lang-key="room_size_title">أبعاد الغرفة الرئيسية</span>
                    </h3>
                    <div>
                        <label id="room-size-label" data-lang-key="room_size_label" for="room-size" class="block text-base font-medium text-slate-700 mb-2">اختر حجم الغرفة المبدئي:</label>
                        <select id="room-size" class="w-full p-3 bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="small" data-lang-key="size_small">صغيرة (Small)</option>
                            <option value="medium" selected data-lang-key="size_medium">متوسطة (Medium)</option>
                            <option value="large" data-lang-key="size_large">كبيرة (Large)</option>
                        </select>
                        <p id="room-size-note" data-lang-key="room_size_note" class="text-sm text-slate-500 mt-2">هذا الاختيار يحدد الأبعاد الافتراضية لجميع قطع الأثاث.</p>
                    </div>
                </div>

                <!-- Main Furniture Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- 1. Closet (دولاب) Card -->
                    <div id="closet-card" class="bg-white p-6 rounded-2xl shadow-md border space-y-4">
                        <div class="flex justify-between items-center border-b pb-3">
                            <h3 id="closet-title" data-lang-key="closet_title" class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/><path d="M9 2v20"/><path d="M15 2v20"/></svg>
                                1. الدولاب
                            </h3>
                            <div class="flex items-center gap-2">
                                <label id="include-closet-label" data-lang-key="include_price" for="include-closet" class="text-sm font-medium text-slate-600">إضافة للسعر</label>
                                <input type="checkbox" id="include-closet" data-card-id="closet-card" class="h-5 w-5 text-indigo-600 rounded border-gray-300 custom-checkbox" checked>
                            </div>
                        </div>
                        <div id="closet-controls" class="space-y-4">
                            <div>
                                <label id="closet-wood-type-label" data-lang-key="closet_wood_type_label" for="closet-wood-type" class="text-sm font-medium text-slate-600 flex items-center">
                                    نوع الخشب
                                    <span class="tooltip-container">
                                        <span class="tooltip-trigger">?</span>
                                        <span id="closet-wood-tooltip" data-lang-key="closet_wood_tooltip" class="tooltip-content text-right">الكونتر السادة هو ببساطة سطح عمل بدون طبقة زينة، بينما كونتر الميلامين هو لوح خشبي مغطى بطبقة من الميلامين توفر سطحاً متيناً لكنه حساس للحرارة والخدوش، بينما كونتر HPL هو الأكثر قوة ومتانة، وهو لوح ديكوري حراري عالي الضغط مقاوم للضربات والخدوش والبقع والحرارة، مما يجعله الخيار الأفضل في الأماكن التي تتطلب أداءً عالياً.</span>
                                    </span>
                                </label>
                                <select id="closet-wood-type" class="w-full mt-1 p-2 rounded-md border border-slate-300">
                                    <option value="counter" data-lang-key="wood_counter">كونتر</option>
                                    <option value="counter_melamine" data-lang-key="wood_melamine">كونتر ميلامين</option>
                                    <option value="hpl_separate" data-lang-key="wood_hpl">HPL</option>
                                </select>
                            </div>
                            <div id="closet-paint-option-container" class="hidden">
                                <label id="closet-paint-type-label" data-lang-key="closet_paint_type_label" for="closet-paint-type" class="text-sm font-medium text-slate-600 flex items-center">
                                    نوع الدهان
                                    <span class="tooltip-container">
                                        <span class="tooltip-trigger">?</span>
                                        <span id="closet-paint-tooltip" data-lang-key="closet_paint_tooltip" class="tooltip-content text-right">دهان الإستر يكشف عن جمال الخشب ويزيد من قيمته بلون طبيعي، بينما دهان الدوكو يغطي الخشب بلون موحد ويوفر متانة ومقاومة عالية للحرارة والرطوبة، ويُستخدم عادةً في أبواب الشقق والغرف والأثاث الذي يحتاج لتحمل.<br><br><b>*دهان الإستر</b><br>المظهر: يُبرز جمال الخشب الطبيعي وثمرته، ويعطي مظهراً فخماً.<br><br><b>*دهان الدوكو</b><br>المظهر: يُغطّي سطح الخشب بلون واحد، مما يمنح مظهراً ناعماً ومستوياً تماماً.<br>المتانة: قوي ويتحمل الظروف المختلفة كالحرارة والرطوبة.</span>
                                    </span>
                                </label>
                                <select id="closet-paint-type" class="w-full mt-1 p-2 rounded-md border border-slate-300">
                                    <option value="none" selected data-lang-key="paint_none">بدون دهان</option>
                                    <option value="ester" data-lang-key="paint_ester">استر (Stain/Varnish)</option>
                                    <option value="duco" data-lang-key="paint_duco">دوكو (Lacquer/Duco)</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label id="closet-width-label" data-lang-key="dim_width" class="text-xs text-slate-500">العرض (سم)</label>
                                    <div class="stepper-container mt-1">
                                        <input type="number" id="closet-width" value="200" min="100" max="400">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="closet-width">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="closet-width">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                                <div>
                                    <label id="closet-height-label" data-lang-key="dim_height" class="text-xs text-slate-500">الارتفاع (سم)</label>
                                     <div class="stepper-container mt-1">
                                        <input type="number" id="closet-height" value="240" min="190" max="300">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="closet-height">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="closet-height">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                                <div>
                                    <label id="closet-depth-label" data-lang-key="dim_depth" class="text-xs text-slate-500">العمق (سم)</label>
                                     <div class="stepper-container mt-1">
                                        <input type="number" id="closet-depth" value="60" min="50">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="closet-depth">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="closet-depth">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label id="closet-doors-label" data-lang-key="dim_doors" class="text-xs text-slate-500">عدد الضُلف</label>
                                     <div class="stepper-container mt-1">
                                        <input type="number" id="closet-doors" value="4" min="1">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="closet-doors">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="closet-doors">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                                <div>
                                    <label id="closet-glass-doors-label" data-lang-key="dim_glass_doors" class="text-xs text-slate-500">ضلف زجاج</label>
                                     <div class="stepper-container mt-1">
                                        <input type="number" id="closet-glass-doors" value="0" min="0">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="closet-glass-doors">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="closet-glass-doors">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                                <div>
                                    <label id="closet-storage-ratio-label" data-lang-key="storage_ratio_label" class="text-sm font-medium text-slate-600">نسبة التخزين</label>
                                    <select id="closet-storage-ratio" class="w-full mt-1 p-2 rounded-md border border-slate-300">
                                        <option value="mostly_hanging" data-lang-key="storage_hanging">أغلبها تعليق (Mostly Hanging)</option>
                                        <option value="balanced" selected data-lang-key="storage_balanced">متوازن (Balanced)</option>
                                        <option value="mostly_folding" data-lang-key="storage_folding">أغلبها طيّ / أرفف (Mostly Folding)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="closet-smart-alert" class="hidden smart-alert"></div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label data-lang-key="door_mech_label" class="text-sm font-medium text-slate-600">آلية الضُلف</label>
                                    <div class="grid grid-cols-1 gap-2 mt-1">
                                        <button type="button" data-value="hinged" class="mechanism-btn p-2 rounded-md border text-center transition-colors">
                                            <span data-lang-key="mech_hinged">مفصلي</span>
                                        </button>
                                        <button type="button" data-value="sliding" class="mechanism-btn p-2 rounded-md border text-center transition-colors">
                                            <span data-lang-key="mech_sliding">جرار</span>
                                        </button>
                                    </div>
                                    <input type="hidden" id="door-mechanism" value="hinged">
                                </div>
                                <div class="flex items-center pt-5"><input type="checkbox" id="closet-led" class="h-4 w-4 text-indigo-600 rounded"><label id="closet-led-label" data-lang-key="closet_led_label" for="closet-led" class="mr-2 text-sm text-slate-700">إضاءة ليد داخلية</label></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Bed & Nightstands Card -->
                    <div id="bed-komod-card" class="bg-white p-6 rounded-2xl shadow-md border space-y-4">
                            <div class="flex justify-between items-center border-b pb-3">
                                <h3 id="bed-title" data-lang-key="bed_title" class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500" style="transform: scaleX(-1);"><path d="M12 2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/><path d="M18 10V8"/><path d="M14 10V8"/><path d="M6 10H4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-4"/></svg>
                                   2. السرير
                                </h3>
                                <div class="flex items-center gap-2">
                                    <label id="include-bed-label" data-lang-key="include_price" for="include-bed" class="text-sm font-medium text-slate-600">إضافة للسعر</label>
                                    <input type="checkbox" id="include-bed" data-card-id="bed-komod-card" class="h-5 w-5 text-indigo-600 rounded border-gray-300 custom-checkbox" checked>
                                </div>
                            </div>
                            <div id="bed-komod-controls" class="space-y-4">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label id="bed-count-label" data-lang-key="dim_bed_count" class="text-sm font-medium text-slate-600">عدد السراير</label>
                                         <div class="stepper-container mt-1">
                                            <input type="number" id="bed-count" value="1" min="1">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="bed-count">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="bed-count">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                    <div><label id="bed-size-label" data-lang-key="dim_bed_size" class="text-sm font-medium text-slate-600">مقاس السرير</label><select id="bed-size" class="w-full mt-1 p-2 rounded-md border border-slate-300"><option value="100">100 سم</option><option value="120">120 سم</option><option value="140">140 سم</option><option value="160" selected>160 سم</option><option value="180">180 سم</option><option value="200">200 سم</option></select></div>
                                </div>
                                <div id="bed-smart-alert" class="hidden smart-alert"></div>
                                <div>
                                    <label id="bed-material-label" data-lang-key="bed_material_label" class="text-sm font-medium text-slate-600">خامة السرير</label>
                                    <select id="bed-material" class="w-full mt-1 p-2 rounded-md border border-slate-300">
                                        <option value="wood" data-lang-key="bed_wood">خشب فقط</option>
                                        <option value="upholstered_back" data-lang-key="bed_back">تنجيد الظهر فقط</option>
                                        <option value="upholstered_full" data-lang-key="bed_full">تنجيد كامل</option>
                                    </select>
                                </div>
                                <div id="bed-paint-option-container" class="hidden">
                                    <label id="bed-paint-type-label" data-lang-key="bed_paint_type_label" for="bed-paint-type" class="text-sm font-medium text-slate-600">نوع دهان السرير</label>
                                    <select id="bed-paint-type" class="w-full mt-1 p-2 rounded-md border border-slate-300">
                                        <option value="none" selected data-lang-key="paint_none">بدون دهان</option>
                                        <option value="ester" data-lang-key="paint_ester">استر</option>
                                        <option value="duco" data-lang-key="paint_duco">دوكو</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-2 pt-2">
                                    <div><div class="flex items-center"><input type="checkbox" id="lifting-mechanism" class="h-4 w-4 text-indigo-600 rounded"><label id="lifting-mechanism-label" data-lang-key="lifting_mech_label" for="lifting-mechanism" class="mr-2 text-sm text-slate-700">ميكانيزم رفع</label></div></div>
                                    <div><div class="flex items-center"><input type="checkbox" id="bed-led" class="h-4 w-4 text-indigo-600 rounded"><label id="bed-led-label" data-lang-key="bed_led_label" for="bed-led" class="mr-2 text-sm text-slate-700">إضاءة ليد للسرير</label></div></div>
                                </div>
                                
                                <div class="pt-4 border-t mt-4 space-y-4">
                                    <h4 id="komod-title" data-lang-key="komod_title" class="font-bold text-slate-700">الكمود (Nightstands)</h4>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label id="komod-count-label" data-lang-key="dim_komod_count" class="text-sm font-medium text-slate-600">عدد الكمود</label>
                                             <div class="stepper-container mt-1">
                                                <input type="number" id="komod-count" value="2" min="0">
                                                <div class="stepper-buttons">
                                                    <button type="button" class="stepper-btn-v" data-action="increment" data-target="komod-count">+</button>
                                                    <button type="button" class="stepper-btn-v" data-action="decrement" data-target="komod-count">-</button>
                                                </div>
                                            </div>
                                            <div class="input-error-message"></div>
                                        </div>
                                        <div>
                                            <label id="komod-drawers-label" data-lang-key="dim_komod_drawers" class="text-sm font-medium text-slate-600">أدراج الكمود</label>
                                             <div class="stepper-container mt-1">
                                                <input type="number" id="komod-drawers" value="2" min="0">
                                                <div class="stepper-buttons">
                                                    <button type="button" class="stepper-btn-v" data-action="increment" data-target="komod-drawers">+</button>
                                                    <button type="button" class="stepper-btn-v" data-action="decrement" data-target="komod-drawers">-</button>
                                                </div>
                                            </div>
                                            <div class="input-error-message"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>

                    <!-- 3. Dresser Card -->
                    <div id="dresser-mirror-card" class="bg-white p-6 rounded-2xl shadow-md border space-y-4 lg:col-span-2">
                        <div class="flex justify-between items-center border-b pb-3">
                            <h3 id="dresser-title" data-lang-key="dresser_title" class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M14.5 17H4a2 2 0 0 0-2 2v2h16v-2a2 2 0 0 0-2-2z"/><path d="M14.5 4h-5L6 7v3h12V7l-3.5-3z"/><path d="M4 17v-3h16v3"/><circle cx="12" cy="12" r="2.5"/></svg>
                                3. التسريحة والمرايا
                            </h3>
                                <div class="flex items-center gap-2">
                                    <label id="include-dresser-label" data-lang-key="include_price" for="include-dresser" class="text-sm font-medium text-slate-600">إضافة للسعر</label>
                                    <input type="checkbox" id="include-dresser" data-card-id="dresser-mirror-card" class="h-5 w-5 text-indigo-600 rounded border-gray-300 custom-checkbox" checked>
                                </div>
                        </div>
                        <div id="dresser-mirror-controls" class="space-y-4">
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                                <div><label id="dresser-type-label" data-lang-key="dresser_type_label" class="text-sm font-medium text-slate-600">طريقة التركيب</label><select id="dresser-type" class="w-full mt-1 p-2 rounded-md border border-slate-300"><option value="hanging" data-lang-key="install_hanging">معلقة</option><option value="floor" selected data-lang-key="install_floor">على الأرض</option></select></div>
                                <div>
                                    <label id="dresser-drawers-label" data-lang-key="dim_drawers" class="text-sm font-medium text-slate-600">عدد الأدراج</label>
                                     <div class="stepper-container mt-1">
                                        <input type="number" id="dresser-drawers" value="3" min="0">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="dresser-drawers">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="dresser-drawers">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                                <div>
                                    <label id="dresser-width-label" data-lang-key="dim_width" class="text-xs text-slate-500">العرض (سم)</label>
                                     <div class="stepper-container mt-1">
                                        <input type="number" id="dresser-width" value="120" min="60">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="dresser-width">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="dresser-width">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                                <div>
                                    <label id="dresser-depth-label" data-lang-key="dim_depth" class="text-xs text-slate-500">العمق (سم)</label>
                                     <div class="stepper-container mt-1">
                                        <input type="number" id="dresser-depth" value="45" min="30">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="dresser-depth">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="dresser-depth">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 pt-4 border-t mt-4">
                                <div>
                                    <label id="mirror-shape-label" data-lang-key="mirror_shape_label" for="mirror-shape" class="text-sm font-medium text-slate-600">شكل المرايا</label>
                                    <div class="flex items-center gap-2">
                                        <select id="mirror-shape" class="w-full mt-1 p-2 rounded-md border border-slate-300">
                                            <option value="rectangle" data-lang-key="shape_rect">مستطيل</option>
                                            <option value="square" data-lang-key="shape_square">مربع</option>
                                            <option value="circle" data-lang-key="shape_circle">دائري</option>
                                        </select>
                                        <div id="mirror-shape-icon-container" class="mt-1 p-2 bg-slate-100 rounded-md h-10 w-10 flex items-center justify-center">
                                            <svg id="icon-rectangle" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><rect width="18" height="12" x="3" y="6" rx="2"/></svg>
                                            <svg id="icon-square" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500 hidden"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>
                                            <svg id="icon-circle" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500 hidden"><circle cx="12" cy="12" r="10"/></svg>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label id="mirror-width-label" data-lang-key="dim_mirror_width" class="text-xs text-slate-500">عرض المرايا (سم)</label>
                                     <div class="stepper-container mt-1">
                                        <input type="number" id="mirror-width" value="70" min="40">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="mirror-width">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="mirror-width">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                                <div id="mirror-height-container">
                                    <label id="mirror-height-label" data-lang-key="dim_mirror_height" class="text-xs text-slate-500">ارتفاع المرايا (سم)</label>
                                     <div class="stepper-container mt-1">
                                        <input type="number" id="mirror-height" value="100" min="60">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="mirror-height">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="mirror-height">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                                <div class="flex items-end pb-1"><div class="flex items-center"><input type="checkbox" id="mirror-led" class="h-4 w-4 text-indigo-600 rounded"><label id="mirror-led-label" data-lang-key="mirror_led_label" for="mirror-led" class="mr-2 text-sm text-slate-700">إضاءة ليد للمرايا</label></div></div>
                            </div>
                        </div>
                    </div>

                </div> <!-- End Grid -->

                <!-- Additional Furniture Section -->
                <div class="bg-white p-6 rounded-2xl shadow-md border space-y-6">
                    <h3 id="additional-furniture-title" data-lang-key="additional_furniture_title" class="text-xl font-bold text-slate-800 border-b pb-3 flex items-center gap-2">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M20 10V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v3"/><path d="M2 15h20"/><path d="M4 15v5a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5"/></svg>
                       4. قطع أثاث إضافية
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- TV Table -->
                        <div id="tv-table-card" class="space-y-3 p-4 border rounded-lg bg-slate-50">
                            <div class="flex justify-between items-center">
                                <h4 id="tv-table-unit-title" data-lang-key="tv_table_unit_title" class="font-bold text-slate-700">ترابيزة تليفزيون (TV Unit)</h4>
                                <div class="flex items-center gap-2">
                                    <label id="include-tv-table-label" data-lang-key="include_price" for="include-tv-table" class="text-sm font-medium text-slate-600">إضافة للسعر</label>
                                    <input type="checkbox" id="include-tv-table" data-card-id="tv-table-card" class="h-5 w-5 text-indigo-600 rounded border-gray-300 custom-checkbox">
                                </div>
                            </div>
                            <div id="tv-table-controls" class="space-y-3">
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label id="tv-table-width-label" data-lang-key="dim_width" class="text-xs text-slate-500">العرض (سم)</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="tv-table-width" value="160" min="80">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="tv-table-width">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="tv-table-width">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                    <div>
                                        <label id="tv-table-height-label" data-lang-key="dim_height" class="text-xs text-slate-500">الارتفاع (سم)</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="tv-table-height" value="50" min="30">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="tv-table-height">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="tv-table-height">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                    <div>
                                        <label id="tv-table-depth-label" data-lang-key="dim_depth" class="text-xs text-slate-500">العمق (سم)</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="tv-table-depth" value="40" min="30">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="tv-table-depth">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="tv-table-depth">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label id="tv-table-drawers-label" data-lang-key="dim_drawers" class="text-xs text-slate-500">عدد الأدراج</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="tv-table-drawers" value="0" min="0">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="tv-table-drawers">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="tv-table-drawers">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                    <div>
                                        <label id="tv-table-doors-label" data-lang-key="dim_doors" class="text-xs text-slate-500">عدد الدولف</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="tv-table-doors" value="0" min="0">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="tv-table-doors">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="tv-table-doors">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                </div>
                                <div>
                                    <label id="tv-table-type-label" data-lang-key="dresser_type_label" class="text-sm font-medium text-slate-600">طريقة التركيب</label>
                                    <select id="tv-table-type" class="w-full mt-1 p-2 rounded-md border border-slate-300">
                                        <option value="floor" selected data-lang-key="install_floor">على الأرض</option>
                                        <option value="hanging" data-lang-key="install_hanging">معلقة</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Coffee Table -->
                        <div id="coffee-table-card" class="space-y-3 p-4 border rounded-lg bg-slate-50">
                            <div class="flex justify-between items-center">
                                <h4 id="coffee-table-title" data-lang-key="coffee_table_title" class="font-bold text-slate-700">ترابيزة وسط (Coffee Table)</h4>
                                <div class="flex items-center gap-2">
                                    <label id="include-coffee-table-label" data-lang-key="include_price" for="include-coffee-table" class="text-sm font-medium text-slate-600">إضافة للسعر</label>
                                    <input type="checkbox" id="include-coffee-table" data-card-id="coffee-table-card" class="h-5 w-5 text-indigo-600 rounded border-gray-300 custom-checkbox">
                                </div>
                            </div>
                            <div id="coffee-table-controls" class="space-y-3">
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label id="coffee-table-width-label" data-lang-key="dim_width" class="text-xs text-slate-500">العرض (سم)</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="coffee-table-width" value="100" min="50">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="coffee-table-width">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="coffee-table-width">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                    <div>
                                        <label id="coffee-table-height-label" data-lang-key="dim_height" class="text-xs text-slate-500">الارتفاع (سم)</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="coffee-table-height" value="45" min="30">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="coffee-table-height">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="coffee-table-height">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                    <div>
                                        <label id="coffee-table-depth-label" data-lang-key="dim_depth" class="text-xs text-slate-500">العمق (سم)</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="coffee-table-depth" value="60" min="40">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="coffee-table-depth">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="coffee-table-depth">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- L-Shape Sofa -->
                        <div id="l-sofa-card" class="space-y-3 p-4 border rounded-lg bg-slate-50">
                            <div class="flex justify-between items-center">
                                <h4 id="l-sofa-title" data-lang-key="l_sofa_title" class="font-bold text-slate-700">ركنة حرف L (Corner Sofa)</h4>
                                <div class="flex items-center gap-2">
                                    <label id="include-l-sofa-label" data-lang-key="include_price" for="include-l-sofa" class="text-sm font-medium text-slate-600">إضافة للسعر</label>
                                    <input type="checkbox" id="include-l-sofa" data-card-id="l-sofa-card" class="h-5 w-5 text-indigo-600 rounded border-gray-300 custom-checkbox">
                                </div>
                            </div>
                            <div id="l-sofa-controls" class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label id="l-sofa-width-label" data-lang-key="dim_width" class="text-xs text-slate-500">العرض (سم)</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="l-sofa-width" value="250" min="150">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="l-sofa-width">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="l-sofa-width">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                    <div>
                                        <label id="l-sofa-depth-label" data-lang-key="dim_depth" class="text-xs text-slate-500">العمق (سم)</label>
                                        <div class="stepper-container mt-1">
                                            <input type="number" id="l-sofa-depth" value="180" min="100">
                                            <div class="stepper-buttons">
                                                <button type="button" class="stepper-btn-v" data-action="increment" data-target="l-sofa-depth">+</button>
                                                <button type="button" class="stepper-btn-v" data-action="decrement" data-target="l-sofa-depth">-</button>
                                            </div>
                                        </div>
                                        <div class="input-error-message"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sofa -->
                        <div id="sofa-card" class="space-y-3 p-4 border rounded-lg bg-slate-50">
                            <div class="flex justify-between items-center">
                                <h4 id="sofa-title" data-lang-key="sofa_title" class="font-bold text-slate-700">كنبة (Sofa)</h4>
                                <div class="flex items-center gap-2">
                                    <label id="include-sofa-label" data-lang-key="include_price" for="include-sofa" class="text-sm font-medium text-slate-600">إضافة للسعر</label>
                                    <input type="checkbox" id="include-sofa" data-card-id="sofa-card" class="h-5 w-5 text-indigo-600 rounded border-gray-300 custom-checkbox">
                                </div>
                            </div>
                            <div id="sofa-controls" class="space-y-3">
                                <div>
                                    <label id="sofa-width-label" data-lang-key="dim_width" class="text-xs text-slate-500">العرض (سم)</label>
                                    <div class="stepper-container mt-1">
                                        <input type="number" id="sofa-width" value="200" min="120">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="sofa-width">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="sofa-width">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Sofa Bed -->
                        <div id="sofa-bed-card" class="space-y-3 p-4 border rounded-lg bg-slate-50 md:col-span-2">
                            <div class="flex justify-between items-center">
                                <h4 id="sofa-bed-title" data-lang-key="sofa_bed_title" class="font-bold text-slate-700">كنبة سرير (Sofa Bed)</h4>
                                <div class="flex items-center gap-2">
                                    <label id="include-sofa-bed-label" data-lang-key="include_price" for="include-sofa-bed" class="text-sm font-medium text-slate-600">إضافة للسعر</label>
                                    <input type="checkbox" id="include-sofa-bed" data-card-id="sofa-bed-card" class="h-5 w-5 text-indigo-600 rounded border-gray-300 custom-checkbox">
                                </div>
                            </div>
                            <div id="sofa-bed-controls" class="space-y-3">
                                <div>
                                    <label id="sofa-bed-width-label" data-lang-key="dim_width" class="text-xs text-slate-500">العرض (سم)</label>
                                    <div class="stepper-container mt-1">
                                        <input type="number" id="sofa-bed-width" value="200" min="120">
                                        <div class="stepper-buttons">
                                            <button type="button" class="stepper-btn-v" data-action="increment" data-target="sofa-bed-width">+</button>
                                            <button type="button" class="stepper-btn-v" data-action="decrement" data-target="sofa-bed-width">-</button>
                                        </div>
                                    </div>
                                    <div class="input-error-message"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Additional Notes -->
                <div class="bg-indigo-50 p-6 rounded-2xl border-2 border-indigo-200 shadow-inner">
                     <h3 id="notes-title" data-lang-key="notes_title" class="text-xl font-bold mb-3 text-indigo-700">5. ملاحظات إضافية أو طلبات خاصة</h3>
                     <textarea id="additional-notes" rows="3" data-lang-key="notes_placeholder" placeholder="اكتب هنا أي تفاصيل إضافية عن التصميم، خامات معينة، أو ملاحظات للورشة..." class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                </div>


                <div id="quote-action-container" class="text-center pt-8">
                    <button type="button" id="show-quote-btn" data-lang-key="show_quote_btn" class="bg-indigo-600 text-white font-bold transition duration-200 hover:bg-indigo-700 shadow-lg hover:shadow-xl shadow-indigo-300 hover:shadow-indigo-400 w-full max-w-sm py-3 px-6 text-lg rounded-xl inline-flex items-center justify-center gap-2">
                        عرض السعر وطلب التواصل
                    </button>
                    <p id="edit-mode-message" class="hidden mt-4 text-slate-600">
                        <span id="edit-message-text" data-lang-key="edit_mode_message"></span>
                        <button type="button" id="hide-quote-link" class="text-indigo-600 font-bold hover:text-indigo-800 underline p-1">
                            <span id="hide-quote-text" data-lang-key="hide_quote_link">إخفاء شريط السعر</span>
                        </button>
                    </p>
                </div>

            </form>
        </div>

        <div id="guide-view" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-lg border">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 id="guide-title" data-lang-key="guide_title" class="text-2xl font-bold text-indigo-700">دليل المستخدم: نصائح للاستفادة القصوى</h2>
                <button type="button" class="back-to-main-btn text-indigo-600 hover:bg-indigo-100 p-2 rounded-full transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                </button>
            </div>
            <div class="prose prose-lg max-w-none text-slate-700 space-y-4">
                <p id="guide-intro" data-lang-key="guide_intro">أهلاً بك في محاكي الأسعار من "Waleed Designs"! لتصميم غرفة أحلامك والحصول على تقدير دقيق للتكلفة، اتبع هذه النصائح البسيطة:</p>
                <ol class="list-decimal list-inside space-y-3">
                    <li id="guide-step1" data-lang-key="guide_step1">
                        <b>ابدأ صح: اختر حجم غرفتك المبدئي</b><br>
                        أول اختيار في الصفحة "أبعاد الغرفة الرئيسية" (صغيرة، متوسطة، كبيرة) هو نقطة بداية سريعة. سيقوم هذا الاختيار بملء مقاسات افتراضية مناسبة لكل قطع الأثاث، مما يوفر عليك الوقت. لا تقلق، يمكنك تعديل أي مقاس لاحقًا.
                    </li>
                    <li id="guide-step2" data-lang-key="guide_step2">
                        <b>التصميم ملكك: قم بتضمين أو استبعاد أي قطعة</b><br>
                        بجانب كل قطعة أثاث (الدولاب، السرير، إلخ) ستجد خيار "إضافة للسعر". إذا كنت لا تريد قطعة معينة، ببساطة قم بإلغاء تحديدها وسيتم إزالتها من السعر الإجمالي. هذا يسمح لك بتكوين الغرفة التي تحتاجها فقط وبما يناسب ميزانيتك.
                    </li>
                    <li id="guide-step3" data-lang-key="guide_step3">
                        <b>الدقة هي الأهم: أدخل مقاساتك الخاصة</b><br>
                        المقاسات الافتراضية هي مجرد مقترحات. للحصول على أدق تقدير للسعر، ننصحك بقياس المساحة المتوفرة لديك وإدخال الأبعاد الحقيقية في خانات العرض، الارتفاع، والعمق لكل قطعة.
                    </li>
                    <li id="guide-step4" data-lang-key="guide_step4">
                        <b>لا تحتار في الخامات والدهانات (دليلك السريع)</b><br>
                        <ul class="list-disc list-inside mt-2 space-y-1 ps-6">
                            <li id="guide-step4-wood" data-lang-key="guide_step4_wood"><b>نوع الخشب:</b>
                                <ul class="list-circle list-inside ps-6">
                                    <li id="guide-step4-wood-counter" data-lang-key="guide_step4_wood_counter"><b>كونتر:</b> الخيار الأمثل إذا كنت تريد دهانًا بلون معين (دوكو أو استر).</li>
                                    <li id="guide-step4-wood-melamine" data-lang-key="guide_step4_wood_melamine"><b>كونتر ميلامين / HPL:</b> خيارات تأتي بألوانها جاهزة، وهي ممتازة للتصميمات العصرية وسرعة التنفيذ.</li>
                                </ul>
                            </li>
                            <li id="guide-step4-paint" data-lang-key="guide_step4_paint"><b>نوع الدهان:</b>
                               <ul class="list-circle list-inside ps-6">
                                    <li id="guide-step4-paint-ester" data-lang-key="guide_step4_paint_ester"><b>استر (Ester):</b> اختره إذا كنت تحب رؤية شكل عروق الخشب الطبيعية لمظهر فخم وكلاسيكي.</li>
                                    <li id="guide-step4-paint-duco" data-lang-key="guide_step4_paint_duco"><b>دوكو (Duco):</b> اختره إذا كنت تريد لونًا مصمتًا وموحّدًا (مثل الأبيض، الرمادي، إلخ) لمظهر عصري وناعم.</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li id="guide-step5" data-lang-key="guide_step5">
                        <b>لا تفوّت التفاصيل: استخدم علامات الاستفهام (؟)</b><br>
                        بجانب بعض الخيارات الصعبة مثل "نوع الخشب" و"نوع الدهان"، ستجد علامة استفهام صغيرة ?. مرر الماوس فوقها وستظهر لك نافذة صغيرة بها شرح تفصيلي لمساعدتك على اتخاذ القرار الأنسب لك.
                    </li>
                    <li id="guide-step6" data-lang-key="guide_step6">
                        <b>الخطوة الأخيرة: عرض السعر والتواصل</b><br>
                        بعد الانتهاء من تحديد كل المواصفات، اضغط على زر "عرض السعر وطلب التواصل" في الأسفل. سيظهر لك شريط يحتوي على السعر التقديري، ومدة التصنيع المتوقعة. كل ما عليك فعله هو كتابة اسمك ورقم هاتفك ثم الضغط على زر "إرسال الطلب عبر واتساب". سيتم تجهيز رسالة تحتوي على كل اختياراتك بالتفصيل لإرسالها لنا مباشرة.
                    </li>
                </ol>
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-r-lg">
                    <p class="font-bold" id="guide-note-title" data-lang-key="guide_note_title">⭐ ملاحظة هامة جداً: السعر تقديري</p>
                    <p id="guide-note-text" data-lang-key="guide_note_text">السعر الذي يظهر لك هو تقدير مبدئي دقيق بناءً على اختياراتك. السعر النهائي يتم تأكيده بعد التواصل معك، والاتفاق على التفاصيل النهائية ورفع المقاسات الفعلية من الموقع.</p>
                </div>
                <p id="guide-outro" data-lang-key="guide_outro">نأمل أن تساعدك هذه الأداة في تصميم غرفة أحلامك بسهولة!</p>
            </div>
            <div class="text-center mt-8">
                <button type="button" class="back-to-main-btn bg-indigo-600 text-white font-bold transition duration-200 hover:bg-indigo-700 shadow-lg hover:shadow-xl shadow-indigo-300 hover:shadow-indigo-400 py-2 px-6 rounded-xl inline-flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                    <span id="guide-back-button-text" data-lang-key="guide_back_button_text">العودة إلى النموذج</span>
                </button>
            </div>
        </div>


    </div>

    <!-- STICKY FOOTER FOR PRICE & SUBMISSION -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm border-t border-slate-200 shadow-t-xl z-50 hidden">
        <div class="max-w-4xl mx-auto p-4 flex flex-col sm:flex-row justify-between items-center gap-4">
            <!-- Price and Time Display -->
            <div class="flex-grow text-center sm:text-right">
                <p id="footer-price-label" data-lang-key="footer_price_label" class="text-sm font-medium text-slate-500">السعر التقديري المحدد</p>
                <p id="total-price" class="text-3xl font-black text-indigo-700">0 ج.م</p>
                <div id="price-breakdown" class="text-xs text-slate-600 mt-1"></div>
                <p id="delivery-estimate" class="text-sm font-bold text-green-700 mt-2">وقت التصنيع المقدر: 0 أسابيع</p>
                <p id="footer-disclaimer" data-lang-key="footer_disclaimer" class="text-xs text-slate-500 mt-1">هذا السعر هو تقدير مبدئي غير مُلزم، ويخضع للتأكيد والقياسات النهائية</p>
                <p id="footer-promo-message" data-lang-key="footer_promo_message" class="text-sm font-bold text-indigo-600 mt-2"></p>
                <p id="price-error-message" class="text-xs text-red-600 h-4"></p>
            </div>
            <!-- Contact Info & Submit -->
            <div class="flex-shrink-0 w-full sm:w-auto flex flex-col items-center sm:items-stretch gap-2">
                <div class="w-full grid grid-cols-1 sm:grid-cols-3 gap-2">
                    <input type="text" id="customer-name" placeholder="الاسم بالكامل *" class="w-full p-2 text-sm rounded-md border border-slate-300 animate-pulse-shadow" required data-lang-key="placeholder_name">
                    <input type="tel" id="customer-phone" placeholder="رقم التليفون *" class="w-full p-2 text-sm rounded-md border border-slate-300 animate-pulse-shadow" required data-lang-key="placeholder_phone">
                    <input type="text" id="customer-city" placeholder="المدينة / المحافظة *" class="w-full p-2 text-sm rounded-md border border-slate-300 animate-pulse-shadow" required data-lang-key="placeholder_city">
                </div>
                <div class="w-full mt-2 text-center sm:text-right">
                    <div class="inline-flex items-center gap-2">
                        <input type="checkbox" id="request-appointment" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="request-appointment" data-lang-key="request_appointment_label" class="text-sm text-slate-700 select-none cursor-pointer">اقتراح موعد لرفع المقاسات</label>
                    </div>
                    <div id="appointment-date-container" class="mt-2 hidden">
                        <input type="date" id="appointment-date" class="p-2 text-sm rounded-md border border-slate-300 w-full sm:w-auto">
                    </div>
                </div>
                 <button type="button" id="request-quote-btn" class="bg-green-500 text-white font-bold transition duration-200 hover:bg-green-600 disabled:bg-slate-400 disabled:cursor-not-allowed disabled:shadow-none shadow-lg hover:shadow-xl shadow-green-300 hover:shadow-green-400 w-full py-2 px-6 mt-2 rounded-xl inline-flex items-center justify-center gap-2" disabled>
                     <span id="request-quote-text" data-lang-key="request_quote_text">إرسال الطلب عبر واتساب</span>
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                 </button>
                 <button type="button" id="export-share-btn" class="bg-indigo-600 text-white font-bold transition duration-200 hover:bg-indigo-700 shadow-lg hover:shadow-xl shadow-indigo-300 hover:shadow-indigo-400 w-full py-2 px-6 mt-2 rounded-xl inline-flex items-center justify-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                      <span data-lang-key="export_share_btn">التصميم 2D / مشاركة</span>
                </button>
            </div>
        </div>
    </footer>

    <!-- MODAL for alerts -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60] opacity-0 pointer-events-none modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center transform scale-95 opacity-0 modal-content">
            <h3 id="modal-title" class="text-lg font-bold text-slate-800">تنبيه</h3>
            <p id="modal-message" class="text-slate-600 mt-2 mb-6">محتوى الرسالة هنا.</p>
            <button id="modal-close-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition" data-lang-key="modal_ok">حسنًا</button>
        </div>
    </div>

    <!-- MODAL for restoring session -->
    <div id="restore-session-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[70] opacity-0 pointer-events-none modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center transform scale-95 opacity-0 modal-content">
            <h3 id="restore-modal-title" class="text-lg font-bold text-slate-800" data-lang-key="restore_title">استكمال التصميم السابق</h3>
            <p id="restore-modal-message" class="text-slate-600 mt-2 mb-6" data-lang-key="restore_message">وجدنا تصميمًا غير مكتمل. هل ترغب في استكماله؟</p>
            <div class="flex justify-center gap-4">
                <button id="restore-yes-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition" data-lang-key="restore_yes">نعم، استكمل</button>
                <button id="restore-no-btn" class="bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-400 transition" data-lang-key="restore_no">لا، ابدأ من جديد</button>
            </div>
        </div>
    </div>
    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL APP STATE & CONFIG ---
        const App = {
            db: null,
            auth: null,
            currentUserId: null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            elements: {},
            currentLang: 'ar', // Default language
            config: {
                WHATSAPP_NUMBER: "201110846333", // Business WhatsApp number
                DESIGN_DOC_ID: 'current_design', // Firestore document ID
                COSTS: {
                    // Prices are estimates per square/linear meter in EGP
                    WOOD_BASE: { 'counter': 2800, 'counter_melamine': 2320, 'hpl_separate': 2720 }, // Price per m²
                    PAINT: { 'ester': 200, 'duco': 400, 'none': 0 }, // Additional price per m²
                    CLOSET: { 
                        'sliding': 200, 'glass_door': 1500, 'wood_door_deduction': 1000, 'led': 1200, 
                        'internal_drawer_cost': 400, 
                        'shelf_cost': 80,
                        'DISCOUNT_FACTOR': 0.90 // 10% discount
                    }, 
                    BED: { 'lifting_mechanism': 3600, 'upholstered_back': 1600, 'upholstered_full': 3200, 'led': 640 }, 
                    BED_SIZE_PRICES: {
                        '100': 9000, '120': 9000, '140': 12000, '160': 14000, '180': 15500, '200': 18000
                    },
                    KOMOD: { 'base_price': 1440, 'drawer_cost': 480 }, 
                    DRESSER: { 'hanging_premium': 400, 'drawer_cost': 560 },
                    MIRROR: { 'base_area_cost_per_sqm': 800, 'led': 960 }, 
                    TABLES: { 'base_cost_per_sqm': 2400, 'drawer_cost': 500, 'door_cost': 350, 'hanging_premium': 400 }, 
                    SOFAS: { 'l_shape': 6300, 'sofa': 6300, 'sofa_bed': 9000 }, 
                },
                DELIVERY_TIMES: {
                    'counter': 10, 'counter_melamine': 6, 'hpl_separate': 6,
                    'bed': 4, 'komod': 4, 'dresser': 4,
                    'table': 4, // For TV table and coffee table
                    'sofa': 4 // For L-Sofa, Sofa, Sofa Bed
                },
                DIMENSIONS: {
                    'small': { closet: { w: 160, h: 220 }, bed_size: '140', dresser: { w: 100, d: 40, drawers: 2 }, mirror: { w: 60, h: 90 } },
                    'medium': { closet: { w: 200, h: 240 }, bed_size: '160', dresser: { w: 120, d: 45, drawers: 3 }, mirror: { w: 70, h: 100 } },
                    'large': { closet: { w: 250, h: 250 }, bed_size: '180', dresser: { w: 140, d: 50, drawers: 4 }, mirror: { w: 80, h: 120 } }
                },
                 ROOM_VISUAL_DIMS: { // Dimensions for the 2D visualizer in cm
                    'small': { w: 350, d: 450 },
                    'medium': { w: 400, d: 500 },
                    'large': { w: 500, d: 600 }
                },
                STORAGE_RATIOS: { // Maps ratio to internal drawers/shelves for pricing
                    'mostly_hanging': { drawers: 1, shelves: 2, description: {ar: 'أغلبها تعليق', en: 'Mostly Hanging'} },
                    'balanced': { drawers: 3, shelves: 6, description: {ar: 'متوازن', en: 'Balanced'} },
                    'mostly_folding': { drawers: 5, shelves: 10, description: {ar: 'أغلبها طيّ / أرفف', en: 'Mostly Folding'} }
                },
                LANGUAGES: {
                    ar: {
                        dir: 'rtl', langName: 'English', langShortName: 'AR', 
                        app_title: 'Waleed Designs - مُحاكي تصميم غرف النوم', header_subtitle: 'محاكي الأسعار التفاعلي',
                        guide_button_text: 'دليل الاستخدام', reset_button_text: 'إعادة تعيين', export_share_btn: 'التصميم 2D / مشاركة',
                        summary_title: 'ملخص التصميم',
                        visualizer_title: 'تصور مبدئي للغرفة',
                        visualizer_closet_details_title: 'تصور تفصيلي للدولاب',
                        visualizer_closet: 'دولاب', visualizer_bed: 'سرير', visualizer_komod: 'كمود', visualizer_dresser: 'تسريحة',
                        print_button_text: 'حفظ/مشاركة',
                        print_share_tip_mobile: 'على الموبايل، استخدم زر المشاركة الموجود في نافذة الطباعة لإرسال الملف كـ PDF.',
                        generating_pdf: 'جاري إنشاء الملف...',
                        guide_title: 'دليل المستخدم: نصائح للاستفادة القصوى',
                        guide_intro: 'أهلاً بك في محاكي الأسعار من "Waleed Designs"! لتصميم غرفة أحلامك والحصول على تقدير دقيق للتكلفة، اتبع هذه النصائح البسيطة:',
                        guide_step1: '<b>ابدأ صح: اختر حجم غرفتك المبدئي</b><br>أول اختيار في الصفحة "أبعاد الغرفة الرئيسية" (صغيرة، متوسطة، كبيرة) هو نقطة بداية سريعة. سيقوم هذا الاختيار بملء مقاسات افتراضية مناسبة لكل قطع الأثاث، مما يوفر عليك الوقت. لا تقلق، يمكنك تعديل أي مقاس لاحقًا.',
                        guide_step2: '<b>التصميم ملكك: قم بتضمين أو استبعاد أي قطعة</b><br>بجانب كل قطعة أثاث (الدولاب، السرير، إلخ) ستجد خيار "إضافة للسعر". إذا كنت لا تريد قطعة معينة، ببساطة قم بإلغاء تحديدها وسيتم إزالتها من السعر الإجمالي. هذا يسمح لك بتكوين الغرفة التي تحتاجها فقط وبما يناسب ميزانيتك.',
                        guide_step3: '<b>الدقة هي الأهم: أدخل مقاساتك الخاصة</b><br>المقاسات الافتراضية هي مجرد مقترحات. للحصول على أدق تقدير للسعر، ننصحك بقياس المساحة المتوفرة لديك وإدخال الأبعاد الحقيقية في خانات العرض، الارتفاع، والعمق لكل قطعة.',
                        guide_step4: '<b>لا تحتار في الخامات والدهانات (دليلك السريع)</b>',
                        guide_step4_wood: '<b>نوع الخشب:</b>',
                        guide_step4_wood_counter: '<b>كونتر:</b> الخيار الأمثل إذا كنت تريد دهانًا بلون معين (دوكو أو استر).',
                        guide_step4_wood_melamine: '<b>كونتر ميلامين / HPL:</b> خيارات تأتي بألوانها جاهزة، وهي ممتازة للتصميمات العصرية وسرعة التنفيذ.',
                        guide_step4_paint: '<b>نوع الدهان:</b>',
                        guide_step4_paint_ester: '<b>استر (Ester):</b> اختره إذا كنت تحب رؤية شكل عروق الخشب الطبيعية لمظهر فخم وكلاسيكي.',
                        guide_step4_paint_duco: '<b>دوكو (Duco):</b> اختره إذا كنت تريد لونًا مصمتًا وموحّدًا (مثل الأبيض، الرمادي، إلخ) لمظهر عصري وناعم.',
                        guide_step5: '<b>لا تفوّت التفاصيل: استخدم علامات الاستفهام (؟)</b><br>بجانب بعض الخيارات الصعبة مثل "نوع الخشب" و"نوع الدهان"، ستجد علامة استفهام صغيرة ?. مرر الماوس فوقها وستظهر لك نافذة صغيرة بها شرح تفصيلي لمساعدتك على اتخاذ القرار الأنسب لك.',
                        guide_step6: '<b>الخطوة الأخيرة: عرض السعر والتواصل</b><br>بعد الانتهاء من تحديد كل المواصفات، اضغط على زر "عرض السعر وطلب التواصل" في الأسفل. سيظهر لك شريط يحتوي على السعر التقديري، ومدة التصنيع المتوقعة. كل ما عليك فعله هو كتابة اسمك ورقم هاتفك ثم الضغط على زر "إرسال الطلب عبر واتساب". سيتم تجهيز رسالة تحتوي على كل اختياراتك بالتفصيل لإرسالها لنا مباشرة.',
                        guide_note_title: '⭐ ملاحظة هامة جداً: السعر تقديري',
                        guide_note_text: 'السعر الذي يظهر لك هو تقدير مبدئي دقيق بناءً على اختياراتك. السعر النهائي يتم تأكيده بعد التواصل معك، والاتفاق على التفاصيل النهائية ورفع المقاسات الفعلية من الموقع.',
                        guide_outro: 'نأمل أن تساعدك هذه الأداة في تصميم غرفة أحلامك بسهولة!',
                        guide_back_button_text: 'العودة إلى النموذج',

                        room_size_title: 'أبعاد الغرفة الرئيسية', room_size_label: 'اختر حجم الغرفة المبدئي:', room_size_note: 'هذا الاختيار يحدد الأبعاد الافتراضية لجميع قطع الأثاث.',
                        size_small: 'صغيرة (Small)', size_medium: 'متوسطة (Medium)', size_large: 'كبيرة (Large)',
                        include_price: 'إضافة للسعر', dim_width: 'العرض (سم)', dim_height: 'الارتفاع (سم)', dim_depth: 'العمق (سم)', dim_doors: 'عدد الضُلف', dim_glass_doors: 'ضلف زجاج', dim_drawers: 'عدد الأدراج', dim_komod_drawers: 'أدراج الكمود', dim_bed_count: 'عدد السراير', dim_bed_size: 'مقاس السرير', dim_mirror_width: 'عرض المرايا (سم)', dim_mirror_height: 'ارتفاع المرايا (سم)', dim_mirror_diameter: 'قطر المرايا (سم)', dim_mirror_side: 'طول ضلع المرايا (سم)',
                        dim_komod_count: 'عدد الكمود',
                        
                        closet_title: '1. الدولاب', closet_wood_type_label: 'نوع الخشب', closet_paint_type_label: 'نوع الدهان', storage_ratio_label: 'نسبة التخزين', door_mech_label: 'آلية الضُلف', closet_led_label: 'إضافة إضاءة ليد داخلية',
                        closet_wood_tooltip: 'الكونتر السادة هو ببساطة سطح عمل بدون طبقة زينة، بينما كونتر الميلامين هو لوح خشبي مغطى بطبقة من الميلامين توفر سطحاً متيناً لكنه حساس للحرارة والخدوش، بينما كونتر HPL هو الأكثر قوة ومتانة، وهو لوح ديكوري حراري عالي الضغط مقاوم للضربات والخدوش والبقع والحرارة، مما يجعله الخيار الأفضل في الأماكن التي تتطلب أداءً عالياً.',
                        closet_paint_tooltip: 'دهان الإستر يكشف عن جمال الخشب ويزيد من قيمته بلون طبيعي، بينما دهان الدوكو يغطي الخشب بلون موحد ويوفر متانة ومقاومة عالية للحرارة والرطوبة، ويُستخدم عادةً في أبواب الشقق والغرف والأثاث الذي يحتاج لتحمل.<br><br><b>*دهان الإستر</b><br>المظهر: يُبرز جمال الخشب الطبيعي وثمرته، ويعطي مظهراً فخماً.<br><br><b>*دهان الدوكو</b><br>المظهر: يُغطّي سطح الخشب بلون واحد، مما يمنح مظهراً ناعماً ومستوياً تماماً.<br>المتانة: قوي ويتحمل الظروف المختلفة كالحرارة والرطوبة.',

                        bed_title: '2. السرير', komod_title: 'الكمود (Nightstands)', bed_material_label: 'خامة السرير', bed_paint_type_label: 'نوع دهان السرير', lifting_mech_label: 'ميكانيزم رفع', bed_led_label: 'إضاءة ليد للسرير',
                        dresser_title: '3. التسريحة والمرايا', dresser_type_label: 'طريقة التركيب', mirror_shape_label: 'شكل المرايا', mirror_led_label: 'إضاءة ليد للمرايا',
                        additional_furniture_title: '4. قطع أثاث إضافية', tv_table_unit_title: 'ترابيزة تليفزيون (TV Unit)', coffee_table_title: 'ترابيزة وسط (Coffee Table)', l_sofa_title: 'ركنة حرف L (Corner Sofa)', sofa_title: 'كنبة (Sofa)', sofa_bed_title: 'كنبة سرير (Sofa Bed)',
                        boolean: { true: 'نعم', false: 'لا' },

                        install_hanging: 'معلقة', install_floor: 'على الأرض', mech_hinged: 'مفصلي', mech_sliding: 'جرار',
                        wood_counter: 'كونتر', wood_melamine: 'كونتر ميلامين', wood_hpl: 'HPL',
                        paint_none: 'بدون دهان', paint_ester: 'استر (Stain/Varnish)', paint_duco: 'دوكو (Lacquer/Duco)',
                        bed_wood: 'خشب فقط', bed_back: 'تنجيد الظهر فقط', bed_full: 'تنجيد كامل',
                        shape_rect: 'مستطيل', shape_square: 'مربع', shape_circle: 'دائري',
                        storage_hanging: 'أغلبها تعليق (Mostly Hanging)', storage_balanced: 'متوازن (Balanced)', storage_folding: 'أغلبها طيّ / أرفف (Mostly Folding)',
                        
                        notes_title: '5. ملاحظات إضافية أو طلبات خاصة', notes_placeholder: 'اكتب هنا أي تفاصيل إضافية عن التصميم، خامات معينة، أو ملاحظات للورشة...',
                        show_quote_btn: 'عرض السعر وطلب التواصل', placeholder_name: 'الاسم بالكامل *', placeholder_phone: 'رقم التليفون *', request_quote_text: 'إرسال الطلب عبر واتساب',
                        placeholder_city: 'المدينة / المحافظة *',
                        request_appointment_label: 'اقتراح موعد لرفع المقاسات',
                        whatsapp_appointment_date: 'موعد مقترح لرفع المقاسات',
                        footer_price_label: 'السعر التقديري المحدد', footer_disclaimer: 'هذا السعر هو تقدير مبدئي غير مُلزم، ويخضع للتأكيد والقياسات النهائية',
                        delivery_estimate_text: 'وقت التصنيع المقدر:', delivery_weeks_unit: 'أسابيع',
                        modal_alert: 'تنبيه', modal_error: 'خطأ', modal_ok: 'حسنًا',
                        validation_invalid_value: 'قيمة غير صالحة. يجب أن تكون {minRequiredMessage}.',
                        validation_positive_or_zero: 'صفر أو أكثر',
                        validation_greater_than_or_equal: '{min} أو أكثر',
                        validation_less_than_or_equal: '{max} أو أقل',
                        validation_glass_doors_error: 'عدد ضلف الزجاج لا يمكن أن يتجاوز العدد الإجمالي للضلف.',
                        validation_send_error: 'لا يمكن إرسال الطلب. {error}', validation_input_error: 'خطأ في الإدخال', validation_specs_error: 'خطأ في المواصفات', validation_success: 'تم بنجاح', validation_success_message: 'تم تجهيز طلبك بنجاح! سيتم الآن فتح واتساب لإتمام الإرسال.',
                        validation_fix_fields: 'الرجاء تصحيح الحقول التي تحتوي على أخطاء.',
                        edit_mode_message: 'يمكنك تعديل المواصفات في أي وقت.',
                        hide_quote_link: 'إخفاء شريط السعر',
                        facebook_page: 'صفحتنا على فيسبوك',
                        customer_service: 'خدمة العملاء',
                        footer_promo_message: 'أرسل طلبك الآن لتحصل على معاينة مجانية',
                        restore_title: 'استكمال التصميم السابق',
                        restore_message: 'وجدنا تصميمًا غير مكتمل. هل ترغب في استكماله؟',
                        restore_yes: 'نعم، استكمل',
                        restore_no: 'لا، ابدأ من جديد',
                        popup_blocker_alert: 'يرجى السماح بظهور النوافذ المنبثقة لهذا الموقع لعرض ملخص التصميم.',
                        share_error: 'حدث خطأ أثناء محاولة مشاركة الملف.',
                        smart_alert_bed_wider_than_closet: 'ملاحظة: مقاس السرير الذي اخترته أعرض من الدولاب. تأكد من أن مساحة الغرفة كافية.',
                        smart_alert_closet_doors_too_many: 'نصيحة: عدد الضلف كبير جداً بالنسبة للعرض ({doorWidth} سم للضلفة). للحصول على أفضل استخدام، نقترح تقليل العدد إلى {suggestedDoors} ضلف.',
                    },
                    en: {
                        dir: 'ltr', langName: 'العربية', langShortName: 'EN',
                        app_title: 'Waleed Designs - Bedroom Design Simulator', header_subtitle: 'Interactive Price Estimator',
                        guide_button_text: 'User Guide', reset_button_text: 'Reset', export_share_btn: '2D Design / Share',
                        summary_title: 'Design Summary',
                        visualizer_title: 'Room Layout Preview',
                        visualizer_closet_details_title: 'Closet Details',
                        visualizer_closet: 'Closet', visualizer_bed: 'Bed', visualizer_komod: 'Nightstand', visualizer_dresser: 'Dresser',
                        print_button_text: 'Save / Share',
                        print_share_tip_mobile: 'On mobile, use the Share button in the print dialog to send the file as a PDF.',
                        generating_pdf: 'Generating file...',
                        guide_title: 'User Guide: Tips for Maximum Benefit',
                        guide_intro: 'Welcome to the Price Simulator from "Waleed Designs"! To design your dream room and get an accurate cost estimate, follow these simple tips:',
                        guide_step1: '<b>1. Start Right: Choose Your Initial Room Size</b><br>The first choice, "Main Room Dimensions" (Small, Medium, Large), is a quick starting point. This sets suitable default sizes for all furniture, saving you time. You can edit any size later.',
                        guide_step2: '<b>2. Your Design: Include or Exclude Any Piece</b><br>Next to each item, find the "Include in Price" option. Uncheck it to remove it from the total price, allowing you to build only what you need for your budget.',
                        guide_step3: '<b>3. Accuracy is Key: Enter Your Own Measurements</b><br>Default sizes are suggestions. For the most accurate price, measure your space and enter the actual dimensions (width, height, depth) for each piece.',
                        guide_step4: '<b>4. Materials & Paints Quick Guide</b>',
                        guide_step4_wood: '<b>Wood Type:</b>',
                        guide_step4_wood_counter: '<b>Counter:</b> Best if you want a specific paint color (Duco or Ester).',
                        guide_step4_wood_melamine: '<b>Melamine Counter / HPL:</b> Come in ready-made colors, great for modern designs and faster execution.',
                        guide_step4_paint: '<b>Paint Type:</b>',
                        guide_step4_paint_ester: '<b>Ester:</b> Choose this to see the natural wood grain for a classic, luxurious look.',
                        guide_step4_paint_duco: '<b>Duco:</b> Choose this for a solid, uniform color (like white, gray, etc.) for a modern, smooth finish.',
                        guide_step5: '<b>5. Don\'t Miss the Details: Use the Question Marks (?)</b><br>Next to tricky options like "Wood Type" and "Paint Type," you\'ll find a small question mark ?. Hover over it for a detailed explanation to help you decide.',
                        guide_step6: '<b>6. Final Step: View Price & Contact Us</b><br>After finalizing all specifications, click "View Price & Request Contact." A bar will appear with the estimated price and manufacturing time. Just enter your name and phone number, then click "Send Request via WhatsApp." A detailed message with all your selections will be prepared to send to us directly.',
                        guide_note_title: '⭐ Very Important Note: The Price is an Estimate',
                        guide_note_text: 'The price shown is a precise preliminary estimate based on your selections. The final price is confirmed after contacting you, agreeing on final details, and taking actual measurements on-site.',
                        guide_outro: 'We hope this tool helps you design your dream room with ease!',
                        guide_back_button_text: 'Back to Form',
                        
                        room_size_title: 'Main Room Dimensions', room_size_label: 'Choose Initial Room Size:', room_size_note: 'This selection sets the default dimensions for all furniture pieces.',
                        size_small: 'Small', size_medium: 'Medium', size_large: 'Large',
                        include_price: 'Include in Price', dim_width: 'Width (cm)', dim_height: 'Height (cm)', dim_depth: 'Depth (cm)', dim_doors: 'No. of Doors', dim_glass_doors: 'Glass Doors', dim_drawers: 'No. of Drawers', dim_komod_drawers: 'Nightstand Drawers', dim_bed_count: 'No. of Beds', dim_bed_size: 'Bed Size', dim_mirror_width: 'Mirror Width (cm)', dim_mirror_height: 'Mirror Height (cm)', dim_mirror_diameter: 'Mirror Diameter (cm)', dim_mirror_side: 'Mirror Side Length (cm)',
                        dim_komod_count: 'No. of Nightstands',

                        closet_title: '1. Closet', closet_wood_type_label: 'Wood Type', closet_paint_type_label: 'Paint Type', storage_ratio_label: 'Storage Ratio', door_mech_label: 'Door Mechanism', closet_led_label: 'Add Internal LED Lighting',
                        closet_wood_tooltip: 'Counter is a basic surface. Melamine counter is covered with melamine layer, durable but sensitive to heat/scratches. HPL counter is highly durable, scratch/stain/heat resistant, and is the preferred high-performance option.',
                        closet_paint_tooltip: 'Ester paint highlights natural wood grain for a luxurious look. Duco paint provides solid color coverage, offering high durability and resistance to heat and humidity, often used for high-traffic furniture.<br><br><b>*Ester Paint</b>: Shows wood grain, luxurious.<br><br><b>*Duco Paint</b>: Solid color, smooth finish, high durability.',

                        bed_title: '2. Bed', komod_title: 'Nightstands', bed_material_label: 'Bed Material', bed_paint_type_label: 'Bed Paint Type', lifting_mech_label: 'Lifting Mechanism', bed_led_label: 'Bed LED Lighting',
                        dresser_title: '3. Dresser & Mirror', dresser_type_label: 'Installation Type', mirror_shape_label: 'Mirror Shape', mirror_led_label: 'Mirror LED Lighting',
                        additional_furniture_title: '4. Additional Furniture', tv_table_unit_title: 'TV Unit', coffee_table_title: 'Coffee Table', l_sofa_title: 'L-Shape Corner Sofa', sofa_title: 'Sofa', sofa_bed_title: 'Sofa Bed',

                        install_hanging: 'Hanging', install_floor: 'Floor Standing', mech_hinged: 'Hinged', mech_sliding: 'Sliding',
                        wood_counter: 'Counter', wood_melamine: 'Melamine Counter', wood_hpl: 'HPL',
                        paint_none: 'No Paint', paint_ester: 'Ester (Stain/Varnish)', paint_duco: 'Duco (Lacquer/Duco)',
                        bed_wood: 'Wood Only', bed_back: 'Upholstered Back Only', bed_full: 'Fully Upholstered',
                        shape_rect: 'Rectangle', shape_square: 'Square', shape_circle: 'Circle',
                        storage_hanging: 'Mostly Hanging', storage_balanced: 'Balanced', storage_folding: 'Mostly Folding/Shelves',
                        boolean: { true: 'Yes', false: 'No' },

                        notes_title: '5. Additional Notes or Special Requests', notes_placeholder: 'Write any extra design details, specific materials, or notes for the workshop here...',
                        show_quote_btn: 'View Price & Request Contact', placeholder_name: 'Full Name *', placeholder_phone: 'Phone Number *', request_quote_text: 'Send Request via WhatsApp',
                        placeholder_city: 'City / Governorate *',
                        request_appointment_label: 'Suggest an appointment for measurements',
                        whatsapp_appointment_date: 'Suggested Appointment Date',
                        footer_price_label: 'Estimated Price', footer_disclaimer: 'This price is a preliminary, non-binding estimate, subject to final confirmation and measurements.',
                        delivery_estimate_text: 'Estimated Manufacturing Time:', delivery_weeks_unit: 'weeks',
                        modal_alert: 'Alert', modal_error: 'Error', modal_ok: 'OK',
                        validation_invalid_value: 'Invalid value. Must be {minRequiredMessage}.',
                        validation_positive_or_zero: 'positive or zero',
                        validation_greater_than_or_equal: 'greater than or equal to {min}',
                        validation_less_than_or_equal: 'less than or equal to {max}',
                        validation_glass_doors_error: 'Number of glass doors cannot exceed total number of doors.',
                        validation_additional_error: 'There are invalid values in the Additional Furniture section.', validation_send_error: 'Cannot send request. {error}', validation_input_error: 'Input Error', validation_specs_error: 'Specification Error', validation_success: 'Success', validation_success_message: 'Your request is ready! WhatsApp will now open to complete the submission.',
                        validation_fix_fields: 'Please correct the invalid fields highlighted in red.',
                        edit_mode_message: 'You can modify specifications at any time.',
                        hide_quote_link: 'Hide Price Bar',
                        facebook_page: 'Our Facebook Page',
                        customer_service: 'Customer Service',
                        footer_promo_message: 'Send your request now for a free consultation.',
                        restore_title: 'Restore Previous Design',
                        restore_message: 'We found an unsaved design. Would you like to continue with it?',
                        restore_yes: 'Yes, Restore',
                        restore_no: 'No, Start New',
                        popup_blocker_alert: 'Please allow pop-ups for this site to display the design summary.',
                        share_error: 'An error occurred while trying to share the file.',
                        smart_alert_bed_wider_than_closet: 'Note: The selected bed size is wider than the closet. Please ensure your room has enough space.',
                        smart_alert_closet_doors_too_many: 'Tip: The number of doors is too high for the width ({doorWidth} cm per door). For best results, we suggest reducing the count to {suggestedDoors} doors.',
                    }
                }
            }
        };

        // --- UTILITY FUNCTIONS ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Debounce function to limit the rate of function calls
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function t(key, replacements = {}) {
            const translation = App.config.LANGUAGES[App.currentLang][key] || key;
            return Object.keys(replacements).reduce((text, repKey) => 
                text.replace(`{${repKey}}`, replacements[repKey]), translation);
        }

        function showAlert(message, title) {
            App.elements.modalTitle.textContent = title || t('modal_alert');
            App.elements.modalMessage.textContent = message;
            App.elements.alertModal.classList.remove('opacity-0', 'pointer-events-none');
            App.elements.modalContent.classList.remove('scale-95', 'opacity-0');
        }

        function hideAlert() {
            App.elements.modalContent.classList.add('scale-95', 'opacity-0');
            App.elements.alertModal.classList.add('opacity-0');
            setTimeout(() => App.elements.alertModal.classList.add('pointer-events-none'), 300);
        }
        
        // Helper to get all form values
        function getFullConfiguration() {
            const elements = App.elements;
            const float = (el) => parseFloat(el.value) || 0;
            const int = (el) => parseInt(el.value) || 0;

            const storageRatio = elements.closetStorageRatio ? App.config.STORAGE_RATIOS[elements.closetStorageRatio.value] : App.config.STORAGE_RATIOS['balanced'];

            return {
                // Includes
                includeCloset: elements.includeCloset.checked, includeBed: elements.includeBed.checked, includeDresser: elements.includeDresser.checked, includeTvTable: elements.includeTvTable.checked, includeCoffeeTable: elements.includeCoffeeTable.checked, 
                includeLSofa: elements.includeLSofa.checked, includeSofa: elements.includeSofa.checked, includeSofaBed: elements.includeSofaBed.checked,
                roomSize: elements.roomSize.value,
                additionalNotes: elements.additionalNotes.value,

                // Closet
                closet: { 
                    woodType: elements.closetWoodType.value, paintType: elements.closetPaintType.value || 'none', 
                    width: float(elements.closetWidth), height: float(elements.closetHeight), depth: float(elements.closetDepth), 
                    doors: int(elements.closetDoors), glassDoors: int(elements.closetGlassDoors), 
                    storageRatio: elements.closetStorageRatio.value, // New ratio field
                    internalDrawers: Math.floor((float(elements.closetWidth) / 50)) * storageRatio.drawers,
                    shelves: Math.floor((float(elements.closetWidth) / 50)) * storageRatio.shelves, 
                    mechanism: elements.doorMechanism.value, hasLed: elements.closetLed.checked 
                },
                // Bed & Komod
                bed: { count: int(elements.bedCount), size: int(elements.bedSize), material: elements.bedMaterial.value, paintType: elements.bedPaintType.value || 'none', hasLiftingMechanism: elements.liftingMechanism.checked, hasLed: elements.bedLed.checked },
                komod: { count: int(elements.komodCount), drawers: int(elements.komodDrawers) },
                // Dresser & Mirror
                dresser: { type: elements.dresserType.value, drawers: int(elements.dresserDrawers), width: float(elements.dresserWidth), depth: float(elements.dresserDepth), mirrorWidth: float(elements.mirrorWidth), mirrorHeight: float(elements.mirrorHeight), mirrorShape: elements.mirrorShape.value, hasMirrorLed: elements.mirrorLed.checked },
                // Tables & Sofas
                tvTable: { type: elements.tvTableType.value, width: float(elements.tvTableWidth), height: float(elements.tvTableHeight), depth: float(elements.tvTableDepth), drawers: int(elements.tvTableDrawers), doors: int(elements.tvTableDoors) },
                coffeeTable: { width: float(elements.coffeeTableWidth), height: float(elements.coffeeTableHeight), depth: float(elements.coffeeTableDepth) },
                lSofa: { width: float(elements.lSofaWidth), depth: float(elements.lSofaDepth) },
                sofa: { width: float(elements.sofaWidth) },
                sofaBed: { width: float(elements.sofaBedWidth) },
            };
        }

        // Calculates the estimated total surface area (m²) for cubic furniture (Wardrobe/Dresser)
        function calculateSurfaceArea(w, h, d) {
            const [widthM, heightM, depthM] = [w / 100, h / 100, d / 100];
            // Area = 2 * (W*H) + 2 * (H*D) + (W*D) - This estimates the wood used for sides, top, bottom, back, and doors.
            return (widthM * heightM * 2) + (widthM * depthM) + (heightM * depthM * 2);
        }
        
        function calculateDeliveryEstimate(config) {
            const D = App.config.DELIVERY_TIMES;
            let maxWeeks = 0;
            
            if (config.includeCloset) {
                const materialTime = D[config.closet.woodType];
                maxWeeks = Math.max(maxWeeks, materialTime || 0);
            }

            if (config.includeBed || (config.includeBed && config.komod.count > 0) || config.includeDresser) {
                maxWeeks = Math.max(maxWeeks, D.bed || 0);
            }

            if (config.includeTvTable || config.includeCoffeeTable) {
                maxWeeks = Math.max(maxWeeks, D.table || 0);
            }
            
            if (config.includeLSofa || config.includeSofa || config.includeSofaBed) {
                 maxWeeks = Math.max(maxWeeks, D.sofa || 0);
            }

            return maxWeeks;
        }

        function calculateTotal() {
            const formConfig = getFullConfiguration();
            const C = App.config.COSTS;
            let total = 0;
            let error = null;
            const breakdown = {};

            // 1. Closet
            if (formConfig.includeCloset) {
                let closetTotal = 0;
                const cl = formConfig.closet;
                if (cl.glassDoors > cl.doors) {
                    error = t('validation_glass_doors_error');
                } else {
                    const area = calculateSurfaceArea(cl.width, cl.height, cl.depth);
                    closetTotal += area * (C.WOOD_BASE[cl.woodType] + C.PAINT[cl.paintType]);
                    closetTotal += cl.internalDrawers * C.CLOSET.internal_drawer_cost;
                    closetTotal += cl.shelves * C.CLOSET.shelf_cost;
                    if (cl.mechanism === 'sliding') closetTotal += cl.doors * C.CLOSET.sliding;
                    if (cl.hasLed) closetTotal += C.CLOSET.led;
                    closetTotal += cl.glassDoors * (C.CLOSET.glass_door - C.CLOSET.wood_door_deduction);
                    closetTotal *= C.CLOSET.DISCOUNT_FACTOR;
                    breakdown.closet = closetTotal;
                    total += closetTotal;
                }
            }

            // 2. Bed & Komod
            if (formConfig.includeBed) {
                let bedAndKomodTotal = 0;
                const be = formConfig.bed;
                const ko = formConfig.komod;
                if (be.count > 0 && be.size > 0) {
                    let bedPrice = C.BED_SIZE_PRICES[be.size] || 0;
                    if (be.material === 'upholstered_back') bedPrice += C.BED.upholstered_back;
                    if (be.material === 'upholstered_full') bedPrice += C.BED.upholstered_full;
                    if (be.hasLiftingMechanism) bedPrice += C.BED.lifting_mechanism;
                    if (be.hasLed) bedPrice += C.BED.led;
                    if (be.material === 'wood') bedPrice += (be.size / 100 * 2) * C.PAINT[be.paintType]; 
                    bedAndKomodTotal += bedPrice * be.count;
                    if (ko.count > 0) {
                        bedAndKomodTotal += ko.count * (C.KOMOD.base_price + (ko.drawers * C.KOMOD.drawer_cost));
                    }
                    breakdown.bed = bedAndKomodTotal;
                    total += bedAndKomodTotal;
                }
            }

            // 3. Dresser & Mirror
            if (formConfig.includeDresser) {
                let dresserTotal = 0;
                const dr = formConfig.dresser;
                if (dr.width > 0) {
                    const dresserHeight = 90; 
                    const area = calculateSurfaceArea(dr.width, dresserHeight, dr.depth);
                    dresserTotal += area * C.WOOD_BASE.counter;
                    dresserTotal += dr.drawers * C.DRESSER.drawer_cost;
                    if (dr.type === 'hanging') dresserTotal += C.DRESSER.hanging_premium;

                    let mirrorArea = 0;
                    if (dr.mirrorShape === 'circle') {
                        mirrorArea = Math.PI * Math.pow(dr.mirrorWidth / 200, 2); 
                    } else if (dr.mirrorShape === 'square') {
                        mirrorArea = Math.pow(dr.mirrorWidth / 100, 2); 
                    } else { // Rectangle
                        mirrorArea = (dr.mirrorWidth / 100) * (dr.mirrorHeight / 100);
                    }
                    dresserTotal += mirrorArea * C.MIRROR.base_area_cost_per_sqm;
                    if (dr.hasMirrorLed) dresserTotal += C.MIRROR.led;
                    breakdown.dresser = dresserTotal;
                    total += dresserTotal;
                }
            }
            
            // 4. Additional Items
            let additionalTotal = 0;
            if(formConfig.includeTvTable){
                const tv = formConfig.tvTable;
                const area = calculateSurfaceArea(tv.width, tv.height, tv.depth);
                let itemTotal = area * C.TABLES.base_cost_per_sqm;
                itemTotal += tv.drawers * C.TABLES.drawer_cost;
                itemTotal += tv.doors * C.TABLES.door_cost;
                if (tv.type === 'hanging') itemTotal += C.TABLES.hanging_premium;
                additionalTotal += itemTotal;
            }
            if(formConfig.includeCoffeeTable){
                const coffee = formConfig.coffeeTable;
                const area = calculateSurfaceArea(coffee.width, coffee.height, coffee.depth);
                additionalTotal += area * C.TABLES.base_cost_per_sqm;
            }
            if (formConfig.includeLSofa) {
                const lSofa = formConfig.lSofa;
                const totalMeters = (lSofa.width / 100) + (lSofa.depth / 100);
                additionalTotal += totalMeters * C.SOFAS.l_shape;
            }
            if (formConfig.includeSofa) {
                additionalTotal += (formConfig.sofa.width / 100) * C.SOFAS.sofa;
            }
            if (formConfig.includeSofaBed) {
                additionalTotal += (formConfig.sofaBed.width / 100) * C.SOFAS.sofa_bed;
            }
            if (additionalTotal > 0) {
                breakdown.additional = additionalTotal;
                total += additionalTotal;
            }

            return { total: !error ? total : -1, error, breakdown };
        }
        
        function runSmartChecks() {
            const config = getFullConfiguration();
            const closetAlertEl = App.elements.closetSmartAlert;
            const bedAlertEl = App.elements.bedSmartAlert;

            // Clear previous alerts
            closetAlertEl.innerHTML = '';
            closetAlertEl.style.display = 'none';
            bedAlertEl.innerHTML = '';
            bedAlertEl.style.display = 'none';

            // 1. Bed vs Closet check
            if (config.includeBed && config.includeCloset && config.bed.size > config.closet.width) {
                bedAlertEl.innerHTML = `💡 ${t('smart_alert_bed_wider_than_closet')}`;
                bedAlertEl.style.display = 'block';
            }

            // 2. Closet doors check
            if (config.includeCloset && config.closet.doors > 1) {
                const doorWidth = Math.round(config.closet.width / config.closet.doors);
                const MIN_DOOR_WIDTH = 40; // Minimum practical door width in cm

                if (doorWidth < MIN_DOOR_WIDTH) {
                    const suggestedDoors = Math.floor(config.closet.width / 50); // Suggest doors around 50cm wide
                    if (suggestedDoors > 0 && suggestedDoors < config.closet.doors) {
                         closetAlertEl.innerHTML = `💡 ${t('smart_alert_closet_doors_too_many', { doorWidth: doorWidth, suggestedDoors: suggestedDoors })}`;
                         closetAlertEl.style.display = 'block';
                    }
                }
            }
        }

        function recalculate() {
            const result = calculateTotal();
            const roundedTotal = Math.round(Math.max(0, result.total));
            const config = getFullConfiguration();
            const deliveryWeeks = calculateDeliveryEstimate(config);

            App.elements.totalPrice.textContent = `${roundedTotal.toLocaleString(App.currentLang === 'ar' ? 'ar-EG' : 'en-US')} ج.م`;
            App.elements.priceErrorMessage.textContent = result.error || '';
            App.elements.deliveryEstimate.textContent = `${t('delivery_estimate_text')} ${deliveryWeeks} ${t('delivery_weeks_unit')}`;

            // Update price breakdown
            const breakdownContainer = App.elements.priceBreakdown;
            let breakdownHtml = '';
            if (result.breakdown) {
                const parts = [];
                if (result.breakdown.closet) parts.push(`${t('closet_title').split('.')[1].trim()}: ${Math.round(result.breakdown.closet).toLocaleString(App.currentLang === 'ar' ? 'ar-EG' : 'en-US')}`);
                if (result.breakdown.bed) parts.push(`${t('bed_title').split('.')[1].trim()}: ${Math.round(result.breakdown.bed).toLocaleString(App.currentLang === 'ar' ? 'ar-EG' : 'en-US')}`);
                if (result.breakdown.dresser) parts.push(`${t('dresser_title').split('.')[1].trim()}: ${Math.round(result.breakdown.dresser).toLocaleString(App.currentLang === 'ar' ? 'ar-EG' : 'en-US')}`);
                if (result.breakdown.additional) parts.push(`${t('additional_furniture_title').split('.')[1].trim()}: ${Math.round(result.breakdown.additional).toLocaleString(App.currentLang === 'ar' ? 'ar-EG' : 'en-US')}`);
                breakdownHtml = parts.join(' | ');
            }
            breakdownContainer.textContent = breakdownHtml;

            runSmartChecks();
        }

        const debouncedRecalculate = debounce(recalculate, 300);

        // --- LANGUAGE HANDLER ---

        function updateLanguage(newLang) {
            const langData = App.config.LANGUAGES[newLang];
            if (!langData) return;

            App.currentLang = newLang;
            localStorage.setItem('appLang', newLang); // Save preference

            // 1. Set main language and direction
            document.documentElement.lang = newLang;
            document.documentElement.dir = langData.dir;
            document.body.dir = langData.dir;

            // 2. Update button text and icon
            if (App.elements.langToggleButton) {
                App.elements.langToggleButton.querySelector('span').textContent = langData.langShortName;
                App.elements.langIconEn.classList.toggle('hidden', newLang === 'ar');
                App.elements.langIconAr.classList.toggle('hidden', newLang === 'en');
            }
            
            // 3. Update element texts and placeholders
            $$('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (langData[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = langData[key];
                    } else {
                        // Preserve child nodes like SVGs by only updating text nodes
                        const icon = el.querySelector('svg');
                        el.innerHTML = langData[key];
                        if (icon) el.prepend(icon, ' ');
                    }
                }
            });

            // 4. Update select options based on data-lang-key
            $$('select option').forEach(option => {
                const key = option.dataset.langKey;
                if (langData[key]) {
                    option.textContent = langData[key];
                }
            });
            
            // Re-apply static text for elements that don't use data-lang-key
            $('#header-title').textContent = 'Waleed Designs';
            

            // 5. Custom handling for ratio descriptions in options
            $$('#closet-storage-ratio option').forEach(option => {
                const ratioKey = option.value;
                if (App.config.STORAGE_RATIOS[ratioKey]) {
                    option.textContent = App.config.STORAGE_RATIOS[ratioKey].description[newLang];
                }
            });

            // 6. Recalculate everything for accurate units/messages
            updateUI(); // This will call recalculate()
        }

        function toggleLanguage() {
            const newLang = App.currentLang === 'ar' ? 'en' : 'ar';
            updateLanguage(newLang);
        }
        
        // --- UI MANIPULATION ---
        function setMechanismButtonState(value) {
            $$('.mechanism-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
            if(App.elements.doorMechanism) App.elements.doorMechanism.value = value;
        }

        function handleCardToggle(checkbox) {
            const cardId = checkbox.dataset.cardId;
            const cardElement = $(`#${cardId}`);
            // Simplified selector logic works for all cards
            const controlsId = `#${cardId.replace('-card', '-controls')}`;
            const controlsElement = $(controlsId);
            const isChecked = checkbox.checked;

            if (!cardElement || !controlsElement) return;

            if (isChecked) {
                cardElement.classList.remove('opacity-50');
                controlsElement.classList.remove('hidden');
            } else {
                cardElement.classList.add('opacity-50');
                controlsElement.classList.add('hidden');
            }
            
            updateUI(); 
        }

        function showQuoteFooter() {
            if (!validateForm()) {
                showAlert(t('validation_fix_fields'), t('validation_input_error'));
                const firstError = $('.border-red-500');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }

            recalculate(); // Ensure price is updated before showing
            App.elements.footer.classList.remove('hidden');
            App.elements.showQuoteBtn.classList.add('hidden');
            App.elements.editModeMessage.classList.remove('hidden');
            setTimeout(() => { 
                // Smooth scroll to the price footer
                App.elements.footer.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }

        function hideQuoteFooter(event) {
            event.preventDefault(); // Stop the default link behavior
            App.elements.footer.classList.add('hidden');
            App.elements.showQuoteBtn.classList.remove('hidden');
            App.elements.editModeMessage.classList.add('hidden');
            // Scroll back to the main button location if needed
            App.elements.showQuoteBtn.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function updateUI() {
            // 1. Closet Paint Option visibility
            const closetWoodType = App.elements.closetWoodType.value;
            App.elements.closetPaintOptionContainer.style.display = (closetWoodType === 'counter') ? 'block' : 'none';
            
            // 2. Bed Paint Option visibility
            const bedMaterial = App.elements.bedMaterial.value;
            App.elements.bedPaintOptionContainer.style.display = (bedMaterial === 'wood') ? 'block' : 'none';

            // 3. Mirror dimensions based on shape
            const mirrorShape = App.elements.mirrorShape.value;
            const widthLabel = App.elements.mirrorWidthLabel;
            const heightContainer = App.elements.mirrorHeightContainer;
            if (mirrorShape === 'circle') {
                widthLabel.textContent = t('dim_mirror_diameter');
                heightContainer.style.display = 'none';
                if (App.elements.mirrorHeight) App.elements.mirrorHeight.value = App.elements.mirrorWidth.value;
            } else if (mirrorShape === 'square') {
                widthLabel.textContent = t('dim_mirror_side');
                heightContainer.style.display = 'none';
                if (App.elements.mirrorHeight) App.elements.mirrorHeight.value = App.elements.mirrorWidth.value;
            } else {
                widthLabel.textContent = t('dim_mirror_width');
                heightContainer.style.display = 'block';
            }
            
            // 4. Toggle mirror shape icon visibility
            if(App.elements.mirrorShapeIconRect) App.elements.mirrorShapeIconRect.classList.toggle('hidden', mirrorShape !== 'rectangle');
            if(App.elements.mirrorShapeIconSquare) App.elements.mirrorShapeIconSquare.classList.toggle('hidden', mirrorShape !== 'square');
            if(App.elements.mirrorShapeIconCircle) App.elements.mirrorShapeIconCircle.classList.toggle('hidden', mirrorShape !== 'circle');

            // 5. Smart Default: Sync closet paint to other paintable items
            const isClosetPaintable = closetWoodType === 'counter';
            const effectiveClosetPaint = isClosetPaintable ? App.elements.closetPaintType.value : 'none';
            if (bedMaterial === 'wood') {
                App.elements.bedPaintType.value = effectiveClosetPaint;
            }

            // 6. Enable/disable submit button based on contact info
            const name = App.elements.customerName.value.trim();
            const phone = App.elements.customerPhone.value.trim();
            const city = App.elements.customerCity.value.trim();
            App.elements.requestQuoteBtn.disabled = !(name && phone && city);

            // 7. Always recalculate after a UI change
            recalculate();
        }
        
        function updateDimensionsBasedOnSize() {
            const size = App.elements.roomSize.value;
            const dims = App.config.DIMENSIONS[size];
            if (!dims) return;

            App.elements.closetWidth.value = dims.closet.w;
            App.elements.closetHeight.value = dims.closet.h;
            App.elements.closetDepth.value = 60; // Standard
            App.elements.bedSize.value = dims.bed_size;
            App.elements.dresserWidth.value = dims.dresser.w;
            App.elements.dresserDepth.value = dims.dresser.d;
            App.elements.dresserDrawers.value = dims.dresser.drawers;
            App.elements.mirrorWidth.value = dims.mirror.w;
            App.elements.mirrorHeight.value = dims.mirror.h;
            
            const width = parseFloat(App.elements.closetWidth.value);
            if (width > 0) {
                App.elements.closetDoors.value = Math.max(1, Math.round(width / 50));
            }

            updateUI();
        }

        // --- VALIDATION ---
        function validateInput(inputElement) {
            if (!inputElement || inputElement.closest('.hidden')) return true;

            const value = parseFloat(inputElement.value);
            const min = parseFloat(inputElement.min);
            const max = parseFloat(inputElement.max);
            const errorContainer = inputElement.closest('div').nextElementSibling;
            let errorMessage = '';

            if (value < 0) {
                let minRequiredMessage = t('validation_positive_or_zero');
                errorMessage = t('validation_invalid_value', { minRequiredMessage: minRequiredMessage });
            } else if (!isNaN(min) && value < min) {
                let minRequiredMessage = t('validation_greater_than_or_equal', { min: min });
                errorMessage = t('validation_invalid_value', { minRequiredMessage: minRequiredMessage });
            } else if (!isNaN(max) && value > max) {
                 let maxRequiredMessage = t('validation_less_than_or_equal', { max: max });
                 errorMessage = t('validation_invalid_value', { minRequiredMessage: maxRequiredMessage });
            }

            // Clear previous error state
            inputElement.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            if (errorContainer && errorContainer.classList.contains('input-error-message')) {
                errorContainer.textContent = '';
            }

            if (errorMessage) {
                inputElement.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                if (errorContainer && errorContainer.classList.contains('input-error-message')) {
                    errorContainer.textContent = errorMessage;
                }
                return false;
            }
            return true;
        }

        function validateForm() {
            let isValid = true;
            $$('.input-error-message').forEach(el => el.textContent = '');
            $$('#configurator-form input.border-red-500').forEach(el => el.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500'));

            // Custom validation for glass doors
            if(App.elements.includeCloset.checked){
                const closetDoors = parseInt(App.elements.closetDoors.value);
                const glassDoors = parseInt(App.elements.closetGlassDoors.value);
                if (!isNaN(closetDoors) && !isNaN(glassDoors) && glassDoors > closetDoors) {
                    App.elements.closetGlassDoors.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    const errorContainer = App.elements.closetGlassDoors.closest('div').nextElementSibling;
                    if (errorContainer) errorContainer.textContent = t('validation_glass_doors_error');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        function resetForm(forceNew = false) {
            // Perform the UI reset immediately for a fast user experience.
            App.elements.configuratorForm.reset();
            
            // Define which items are checked by default
            const defaultCheckedIds = ['include-closet', 'include-bed', 'include-dresser'];
            $$('input[type="checkbox"][data-card-id]').forEach(checkbox => {
                checkbox.checked = defaultCheckedIds.includes(checkbox.id);
                handleCardToggle(checkbox);
            });

            // Set default room size and update dimensions
            App.elements.roomSize.value = 'medium';
            updateDimensionsBasedOnSize();
            
            App.elements.additionalNotes.value = '';
            // updateUI will be called inside updateDimensionsBasedOnSize, which calls recalculate()
            
            if (!App.elements.footer.classList.contains('hidden')) {
                hideQuoteFooter({ preventDefault: () => {} });
            }
            
            $$('.input-error-message').forEach(el => el.textContent = '');
            $$('#configurator-form input.border-red-500').forEach(el => el.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500'));

            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            $('#configurator-form').classList.add('highlight-flash');
            setTimeout(() => $('#configurator-form').classList.remove('highlight-flash'), 700);
            
            // Handle the database deletion in the background, without waiting for it.
            if(!forceNew && App.currentUserId && App.db) {
                 const docRef = doc(App.db, "artifacts", App.appId, "users", App.currentUserId, "designs", App.config.DESIGN_DOC_ID);
                 deleteDoc(docRef).catch(e => console.error("Error removing document in background: ", e));
            }
        }

            // --- EVENT HANDLING & SUBMISSION ---
        function handleMechanismButtons() {
            $$('.mechanism-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.dataset.value;
                    setMechanismButtonState(value);
                    recalculate(); // Use recalculate for instant feedback on click
                });
            });
        }
        
        function handleStepperButtons() {
            App.elements.configuratorForm.addEventListener('click', (e) => {
                const target = e.target.closest('button[data-action][data-target]');
                if (!target) return;

                const action = target.dataset.action;
                const inputId = target.dataset.target;
                const inputElement = $(`#${inputId}`);
                
                if (!inputElement) return;
                
                const step = parseFloat(inputElement.step) || (inputId.includes('door') || inputId.includes('drawer') || inputId.includes('count') ? 1 : 10);
                const min = parseFloat(inputElement.min);
                const max = parseFloat(inputElement.max);
                let value = parseFloat(inputElement.value) || 0;

                if (action === 'increment') {
                    value += step;
                    if (!isNaN(max) && value > max) value = max;
                } else if (action === 'decrement') {
                    value -= step;
                    if (!isNaN(min) && value < min) value = min;
                }

                inputElement.value = value;
                inputElement.dispatchEvent(new Event('input', { bubbles: true }));
            });
        }


        function submitQuote() {
            if (!validateForm()) {
                showAlert(t('validation_fix_fields'), t('validation_input_error'));
                return;
            }
            
            const name = App.elements.customerName.value.trim();
            const phone = App.elements.customerPhone.value.trim();
            const city = App.elements.customerCity.value.trim();
            
            if (!name || !phone || !city) {
                showAlert(t('placeholder_name') + ', ' + t('placeholder_phone') + ', ' + t('placeholder_city'), t('validation_input_error'));
                return;
            }
            
            const { total, error } = calculateTotal(); 
            if (error) {
                showAlert(error, t('validation_specs_error'));
                return;
            }

            const fullConfig = getFullConfiguration();
            const T = App.config.LANGUAGES[App.currentLang];
            const S = App.config.STORAGE_RATIOS;
            const roundedTotal = Math.round(total);
            const deliveryWeeks = calculateDeliveryEstimate(fullConfig);
            
            const summaryParts = [
                `*${T.app_title}*`,
                `*${T.delivery_estimate_text} ${deliveryWeeks} ${T.delivery_weeks_unit}*`,
                `User ID: ${App.currentUserId || 'Unknown'}`,
                '---------------------------------------------',
                `*${T.placeholder_name}:* ${name}`,
                `*${T.placeholder_phone}:* ${phone}`,
                `*${T.placeholder_city.replace(' *', '')}:* ${city}`,
                `*${T.room_size_label}:* ${T[`size_${fullConfig.roomSize}`] || fullConfig.roomSize}`
            ];

            const appointmentDate = App.elements.appointmentDateInput.value;
            if (App.elements.requestAppointmentCheckbox.checked && appointmentDate) {
                summaryParts.splice(6, 0, `*${T.whatsapp_appointment_date}:* ${appointmentDate}`);
            }

            if(fullConfig.includeCloset){
                const ratioDetails = S[fullConfig.closet.storageRatio];
                const ratioDesc = ratioDetails.description[App.currentLang];
                const closetWoodKeyMap = { 'counter': 'wood_counter', 'counter_melamine': 'wood_melamine', 'hpl_separate': 'wood_hpl' };
                let closetWoodLine = `- ${T.closet_wood_type_label}: ${T[closetWoodKeyMap[fullConfig.closet.woodType]]}`;
                if (fullConfig.closet.woodType === 'counter') {
                    closetWoodLine += `\n- ${T.closet_paint_type_label}: ${T[`paint_${fullConfig.closet.paintType}`]}`;
                }

                summaryParts.push(
`---------------------------------------------
*-- ${T.closet_title} --*
${closetWoodLine}
- ${T.dim_width}×${T.dim_height}×${T.dim_depth}: ${fullConfig.closet.width}×${fullConfig.closet.height}×${fullConfig.closet.depth} cm
- ${T.door_mech_label}: ${T[`mech_${fullConfig.closet.mechanism}`]} (${fullConfig.closet.doors} ${T.dim_doors})
- ${T.dim_glass_doors}: ${fullConfig.closet.glassDoors}
- ${T.storage_ratio_label}: ${ratioDesc}
- ${T.closet_led_label}: ${T.boolean[String(fullConfig.closet.hasLed)]}`
                );
            }

            if(fullConfig.includeBed){
                const be = fullConfig.bed;
                const bedMaterialKeyMap = { 'wood': 'bed_wood', 'upholstered_back': 'bed_back', 'upholstered_full': 'bed_full' };
                let bedMaterialLine = `- ${T.bed_material_label}: ${T[bedMaterialKeyMap[be.material]]}`;
                if (be.material === 'wood') {
                    bedMaterialLine += `\n- ${T.bed_paint_type_label}: ${T[`paint_${be.paintType}`]}`;
                }

                summaryParts.push(
`---------------------------------------------
*-- ${T.bed_title} --*
- ${T.dim_bed_count}: ${be.count}
- ${T.dim_bed_size}: ${be.size} cm
${bedMaterialLine}
- ${T.lifting_mech_label}: ${T.boolean[String(be.hasLiftingMechanism)]}
- ${T.bed_led_label}: ${T.boolean[String(be.hasLed)]}
*-- ${T.komod_title} --*
- ${T.dim_komod_count}: ${fullConfig.komod.count}
- ${T.dim_komod_drawers}: ${fullConfig.komod.drawers}`
                );
            }

            if(fullConfig.includeDresser){
                const mirrorShapeKeyMap = { 'rectangle': 'shape_rect', 'square': 'shape_square', 'circle': 'shape_circle' };
                summaryParts.push(
`---------------------------------------------
*-- ${T.dresser_title} --*
- ${T.dresser_type_label}: ${T[`install_${fullConfig.dresser.type}`]}
- ${T.dim_drawers}: ${fullConfig.dresser.drawers}
- ${T.dim_width}×${T.dim_depth} (${T.dresser_title}): ${fullConfig.dresser.width}×${fullConfig.dresser.depth} cm
- ${T.mirror_shape_label}: ${T[mirrorShapeKeyMap[fullConfig.dresser.mirrorShape]]}
- ${T.mirror_led_label}: ${T.boolean[String(fullConfig.dresser.hasMirrorLed)]}`
                );
            }

            // Additional items
            const additionalItemsSummary = [];

            if(fullConfig.includeTvTable){
                const tv = fullConfig.tvTable;
                const details = [
                    `- *${T.tv_table_unit_title}:*`,
                    `  - ${T.dresser_type_label}: ${T[`install_${tv.type}`]}`,
                    `  - ${T.dim_width}×${T.dim_height}×${T.dim_depth}: ${tv.width}×${tv.height}×${tv.depth} cm`,
                ];
                if (tv.drawers > 0) details.push(`  - ${T.dim_drawers}: ${tv.drawers}`);
                if (tv.doors > 0) details.push(`  - ${T.dim_doors}: ${tv.doors}`);
                additionalItemsSummary.push(details.join('\n'));
            }
            if(fullConfig.includeCoffeeTable){
                const coffee = fullConfig.coffeeTable;
                additionalItemsSummary.push(`- *${T.coffee_table_title}:*\n  - ${T.dim_width}×${T.dim_height}×${T.dim_depth}: ${coffee.width}×${coffee.height}×${coffee.depth} cm`);
            }
            if(fullConfig.includeLSofa){
                additionalItemsSummary.push(`- *${T.l_sofa_title}:*\n  - ${T.dim_width}×${T.dim_depth}: ${fullConfig.lSofa.width}×${fullConfig.lSofa.depth} cm`);
            }
            if(fullConfig.includeSofa){
                additionalItemsSummary.push(`- *${T.sofa_title}:*\n  - ${T.dim_width}: ${fullConfig.sofa.width} cm`);
            }
            if(fullConfig.includeSofaBed){
                additionalItemsSummary.push(`- *${T.sofa_bed_title}:*\n  - ${T.dim_width}: ${fullConfig.sofaBed.width} cm`);
            }
            
            if (additionalItemsSummary.length > 0) {
                summaryParts.push(
`---------------------------------------------
*-- ${T.additional_furniture_title} --*
${additionalItemsSummary.join('\n\n')}` // Use double newline for better separation between items
                );
            }
            
            if (fullConfig.additionalNotes.trim()) {
                summaryParts.push(
`---------------------------------------------
*-- ${T.notes_title} --*
${fullConfig.additionalNotes.trim()}`
                );
            }

            summaryParts.push(
`---------------------------------------------
*${T.footer_price_label}: ${roundedTotal.toLocaleString(App.currentLang === 'ar' ? 'ar-EG' : 'en-US')} ج.م*
---------------------------------------------
${T.footer_disclaimer}

---------------------------------------------
*${T.facebook_page}:*
https://facebook.com/waleed.designs.furniture
*${T.customer_service}:*
01110846333
01220431043`
            );

            const summary = summaryParts.join('\n');
            const whatsappUrl = `https://wa.me/${App.config.WHATSAPP_NUMBER}?text=${encodeURIComponent(summary.trim())}`;
            window.open(whatsappUrl, '_blank');
            showAlert(t('validation_success_message'), t('validation_success'));
        }

        // --- NEW FUNCTIONS FOR PRINTABLE SUMMARY ---
        function generateSummaryHTML(config) {
            const T = App.config.LANGUAGES[App.currentLang];
            const S = App.config.STORAGE_RATIOS;
            let html = '';

            const detailItem = (label, value) => {
                if ((!value && typeof value !== 'number') || value === T.paint_none || value === "0" || value === T.boolean.false) return '';
                 const valueDisplay = `<span class="font-semibold text-slate-800 ${App.currentLang === 'ar' ? 'text-left' : 'text-right'}">${value}</span>`;

                return `<div class="flex justify-between py-2 border-b border-slate-100">
                            <dt class="text-slate-600">${label}</dt>
                            <dd>${valueDisplay}</dd>
                        </div>`;
            };
            
            html += `<div class="space-y-8">`;
            
            // Closet
            if (config.includeCloset) {
                const cl = config.closet;
                const ratioDetails = S[cl.storageRatio];
                const ratioDesc = ratioDetails.description[App.currentLang];
                html += `<div>
                            <h3 class="text-xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-3">${T.closet_title}</h3>
                            <dl>
                                ${detailItem(T.closet_wood_type_label, T[`wood_${cl.woodType}`])}
                                ${detailItem(T.closet_paint_type_label, T[`paint_${cl.paintType}`])}
                                ${detailItem(`${T.dim_width}×${T.dim_height}×${T.dim_depth}`, `${cl.width}×${cl.height}×${cl.depth} cm`)}
                                ${detailItem(T.door_mech_label, `${T[`mech_${cl.mechanism}`]} (${cl.doors} ${T.dim_doors})`)}
                                ${detailItem(T.dim_glass_doors, cl.glassDoors)}
                                ${detailItem(T.storage_ratio_label, ratioDesc)}
                                ${detailItem(T.closet_led_label, T.boolean[String(cl.hasLed)])}
                            </dl>
                        </div>`;
            }
            
            // Bed & Komod
            if (config.includeBed) {
                const be = config.bed;
                const ko = config.komod;
                html += `<div>
                            <h3 class="text-xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-3">${T.bed_title} & ${T.komod_title}</h3>
                            <dl>
                                ${detailItem(T.dim_bed_count, be.count)}
                                ${detailItem(T.dim_bed_size, `${be.size} cm`)}
                                ${detailItem(T.bed_material_label, T[`bed_${be.material}`])}
                                ${detailItem(T.bed_paint_type_label, T[`paint_${be.paintType}`])}
                                ${detailItem(T.lifting_mech_label, T.boolean[String(be.hasLiftingMechanism)])}
                                ${detailItem(T.bed_led_label, T.boolean[String(be.hasLed)])}
                                ${detailItem(T.dim_komod_count, ko.count)}
                                ${detailItem(T.dim_komod_drawers, ko.drawers)}
                            </dl>
                        </div>`;
            }

            // Dresser
            if (config.includeDresser) {
                const dr = config.dresser;
                let mirrorDimLabel = T.dim_mirror_width;
                let mirrorDimValue = `${dr.mirrorWidth}×${dr.mirrorHeight} cm`;
                if (dr.mirrorShape === 'circle') {
                     mirrorDimLabel = T.dim_mirror_diameter;
                     mirrorDimValue = `Ø ${dr.mirrorWidth} cm`;
                } else if (dr.mirrorShape === 'square') {
                    mirrorDimLabel = T.dim_mirror_side;
                    mirrorDimValue = `${dr.mirrorWidth}×${dr.mirrorWidth} cm`;
                }
                 html += `<div>
                            <h3 class="text-xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-3">${T.dresser_title}</h3>
                            <dl>
                                ${detailItem(T.dresser_type_label, T[`install_${dr.type}`])}
                                ${detailItem(T.dim_drawers, dr.drawers)}
                                ${detailItem(`${T.dim_width}×${T.dim_depth}`, `${dr.width}×${dr.depth} cm`)}
                                ${detailItem(T.mirror_shape_label, T[`shape_${dr.mirrorShape}`])}
                                ${detailItem(mirrorDimLabel, mirrorDimValue)}
                                ${detailItem(T.mirror_led_label, T.boolean[String(dr.hasMirrorLed)])}
                            </dl>
                        </div>`;
            }
            
            // Additional Furniture
            const additionalItems = [];
            if(config.includeTvTable) additionalItems.push(`<li><b>${T.tv_table_unit_title}:</b> ${config.tvTable.width}×${config.tvTable.height} cm</li>`);
            if(config.includeCoffeeTable) additionalItems.push(`<li><b>${T.coffee_table_title}:</b> ${config.coffeeTable.width}×${config.coffeeTable.depth} cm</li>`);
            if(config.includeLSofa) additionalItems.push(`<li><b>${T.l_sofa_title}:</b> ${config.lSofa.width}×${config.lSofa.depth} cm</li>`);
            if(config.includeSofa) additionalItems.push(`<li><b>${T.sofa_title}:</b> ${T.dim_width} ${config.sofa.width} cm</li>`);
            if(config.includeSofaBed) additionalItems.push(`<li><b>${T.sofa_bed_title}:</b> ${T.dim_width} ${config.sofaBed.width} cm</li>`);
            
            if (additionalItems.length > 0) {
                html += `<div>
                            <h3 class="text-xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-3">${T.additional_furniture_title}</h3>
                            <ul class="list-disc list-inside space-y-1 text-slate-700">${additionalItems.join('')}</ul>
                        </div>`;
            }
            
            // Notes
            if (config.additionalNotes.trim()) {
                html += `<div>
                            <h3 class="text-xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-3">${T.notes_title}</h3>
                            <p class="text-slate-700 whitespace-pre-wrap p-3 bg-slate-50 rounded-md">${config.additionalNotes.trim()}</p>
                        </div>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        function generateLayoutVisualizerSVG(config) {
            if (!config) return '';
            const T = App.config.LANGUAGES[App.currentLang];
            const roomSize = config.roomSize;
            const roomDims = App.config.ROOM_VISUAL_DIMS[roomSize];
            if (!roomDims) return '';

            const roomW = roomDims.w;
            const roomH = roomDims.d;

            const svgWidth = 500;
            const scale = svgWidth / roomW;
            const svgHeight = roomH * scale;

            const viewBox = `-50 -20 ${svgWidth + 100} ${svgHeight + 60}`; // Add padding for labels
            
            const furniture = [];
            
            const defs = ``; // No defs needed
            
            // Helper to get clean Arabic names
            const getArabicName = (key) => {
                let text = T[key] || '';
                // Handle cases like "1. الدولاب"
                if (text.includes('.')) text = text.split('.')[1];
                // Handle cases like "اسم (Name)"
                if (text.includes('(')) text = text.split('(')[0];
                return text.trim();
            };

            // Add closet
            if (config.includeCloset) {
                const cl = config.closet;
                const w = cl.width * scale;
                const d = cl.depth * scale;
                const x = (svgWidth - w) / 2; // Centered on top wall
                const y = 0;
                furniture.push({
                    html: `<g>
                            <rect x="${x}" y="${y}" width="${w}" height="${d}" fill="#c7d2fe" stroke="#4f46e5" stroke-width="0.5"/>
                            <text x="${x + w/2}" y="${y + d/2}" font-size="${10*scale}" text-anchor="middle" dominant-baseline="middle" fill="#312e81" font-weight="bold">${getArabicName('closet_title')}</text>
                            <text x="${x + w/2}" y="${y - (5 * scale)}" font-size="${9*scale}" text-anchor="middle" fill="#334155">${cl.width} cm</text>
                            </g>`
                });
            }

             // Add Dresser
            if (config.includeDresser) {
                const dr = config.dresser;
                const dresserW_scaled = dr.width * scale;
                const dresserD_scaled = dr.depth * scale;
                const x = svgWidth - dresserD_scaled; // Right wall
                const y = (svgHeight - dresserW_scaled) / 2; // Centered vertically
                furniture.push({
                    html: `<g>
                             <rect x="${x}" y="${y}" width="${dresserD_scaled}" height="${dresserW_scaled}" fill="#e5e7eb" stroke="#6b7280" stroke-width="0.5"/>
                             <text x="${x + dresserD_scaled / 2}" y="${y + dresserW_scaled / 2}" font-size="${8 * scale}" text-anchor="middle" dominant-baseline="middle" fill="#1f2937" font-weight="bold">${getArabicName('dresser_title')}</text>
                             <text x="${svgWidth + (12 * scale)}" y="${y + dresserW_scaled / 2}" font-size="${9*scale}" text-anchor="middle" dominant-baseline="middle" fill="#334155" transform="rotate(90, ${svgWidth + (12 * scale)}, ${y + dresserW_scaled / 2})">${dr.width} cm</text>
                            </g>`
                });
            }

            // Add Bed(s) & Komod(s)
            if (config.includeBed && config.bed.count > 0) {
                const be = config.bed;
                const ko = config.komod;
                const bedW = be.size * scale;
                const bedL = 200 * scale; 
                const komodW = 50 * scale;
                const komodD = 40 * scale;
                const spacing = 15 * scale;

                const y_back = svgHeight - (30 * scale); // Imaginary line for the back of the furniture against the wall

                const bedHTML = (x, y) => `<g>
                        <rect x="${x}" y="${y}" width="${bedW}" height="${bedL}" fill="#a5b4fc" stroke="#4f46e5" stroke-width="0.5"/>
                        <text x="${x + bedW/2}" y="${y + bedL/2}" font-size="${10*scale}" text-anchor="middle" dominant-baseline="middle" fill="#312e81" font-weight="bold">${getArabicName('bed_title')}</text>
                        <text x="${x + bedW/2}" y="${y + bedL + (12 * scale)}" font-size="${9*scale}" text-anchor="middle" fill="#334155">${be.size} cm</text>
                    </g>`;
                
                const komodHTML = (x, y) => `<g>
                        <rect x="${x}" y="${y}" width="${komodW}" height="${komodD}" fill="#e0e7ff" stroke="#a5b4fc" stroke-width="0.5"/>
                        <text x="${x + komodW/2}" y="${y + komodD/2}" font-size="${8*scale}" text-anchor="middle" dominant-baseline="middle" fill="#312e81">${getArabicName('komod_title')}</text>
                    </g>`;

                if (be.count === 1) {
                    const items = [];
                    // Place komods flanking the bed
                    if (ko.count >= 1) items.push({ type: 'komod', w: komodW, d: komodD });
                    items.push({ type: 'bed', w: bedW, d: bedL });
                    if (ko.count >= 2) items.push({ type: 'komod', w: komodW, d: komodD });
                    
                    const totalGroupWidth = items.reduce((sum, item) => sum + item.w, 0) + Math.max(0, items.length - 1) * spacing;
                    let currentX = (svgWidth - totalGroupWidth) / 2;
                    
                    items.forEach(item => {
                        const y = y_back - item.d;
                        if (item.type === 'bed') {
                            furniture.push({ html: bedHTML(currentX, y) });
                        } else { // komod
                            furniture.push({ html: komodHTML(currentX, y) });
                        }
                        currentX += item.w + spacing;
                    });

                } else { // 2 or more beds
                    // Layout is Bed - Komod - Bed
                    const komodsBetween = Math.min(1, ko.count); // Max 1 komod between 2 beds
                    const totalGroupWidth = (bedW * 2) + (komodsBetween * komodW) + (komodsBetween > 0 ? spacing * 2 : spacing);
                    let currentX = (svgWidth - totalGroupWidth) / 2;

                    // Bed 1
                    furniture.push({ html: bedHTML(currentX, y_back - bedL) });
                    currentX += bedW + spacing;
                    
                    // Komod (if included)
                    if (komodsBetween > 0) {
                        furniture.push({ html: komodHTML(currentX, y_back - komodD) });
                        currentX += komodW + spacing;
                    }

                    // Bed 2
                    furniture.push({ html: bedHTML(currentX, y_back - bedL) });
                }
            }
            
            // --- Additional Furniture ---
            const sofaDefaultDepth = 90 * scale;

            // L-Sofa (takes priority for seating)
            if (config.includeLSofa) {
                const sofa = config.lSofa;
                const w = sofa.width * scale;
                const d = sofa.depth * scale;
                const x = 0;
                const y = (svgHeight - d) / 2;
                furniture.push({ html: `<g>
                        <rect x="${x}" y="${y}" width="${w}" height="${sofaDefaultDepth}" fill="#d1d5db" stroke="#4b5563" stroke-width="0.5"/>
                        <rect x="${x}" y="${y}" width="${sofaDefaultDepth}" height="${d}" fill="#d1d5db" stroke="#4b5563" stroke-width="0.5"/>
                        <text x="${x + w/2}" y="${y + d/2}" font-size="${8*scale}" text-anchor="middle" dominant-baseline="middle" fill="#1f2937">${getArabicName('l_sofa_title')}</text>
                    </g>` });
            } 
            // Sofa or Sofa Bed
            else if (config.includeSofa || config.includeSofaBed) {
                const sofa = config.includeSofa ? config.sofa : config.sofaBed;
                const title = config.includeSofa ? getArabicName('sofa_title') : getArabicName('sofa_bed_title');
                const w = sofa.width * scale;
                const x = 0;
                const y = (svgHeight - w) / 2; // Rotated against left wall
                furniture.push({ html: `<g>
                        <rect x="${x}" y="${y}" width="${sofaDefaultDepth}" height="${w}" fill="#d1d5db" stroke="#4b5563" stroke-width="0.5"/>
                        <text x="${x + sofaDefaultDepth/2}" y="${y + w/2}" font-size="${8*scale}" text-anchor="middle" dominant-baseline="middle" fill="#1f2937">${title}</text>
                    </g>` });
            }
            
            // TV Unit
            if (config.includeTvTable) {
                const tv = config.tvTable;
                const w = tv.width * scale;
                const d = tv.depth * scale;
                const x = (svgWidth - w) / 2;
                const closetDepth = config.includeCloset ? config.closet.depth * scale : 0;
                const y = closetDepth + (20 * scale); // Positioned below the closet, with a gap
                furniture.push({ html: `<g>
                        <rect x="${x}" y="${y}" width="${w}" height="${d}" fill="#e5e7eb" stroke="#6b7280" stroke-width="0.5"/>
                        <text x="${x + w/2}" y="${y + d/2}" font-size="${8*scale}" text-anchor="middle" dominant-baseline="middle" fill="#1f2937">${getArabicName('tv_table_unit_title')}</text>
                    </g>` });
            }
            
            // Coffee Table
            if (config.includeCoffeeTable) {
                const coffee = config.coffeeTable;
                const w = coffee.width * scale;
                const d = coffee.depth * scale;
                let x, y;

                const hasSofa = config.includeLSofa || config.includeSofa || config.includeSofaBed;
                if (hasSofa) {
                    // If there's a sofa, place coffee table in front of it
                    x = sofaDefaultDepth + (40 * scale);
                    y = (svgHeight - d) / 2;
                } else {
                    // If no sofa, place it in a safe central area, avoiding other furniture
                    x = (svgWidth - w) / 2; // Horizontally centered
                    y = svgHeight * 0.6;   // Position in the lower-middle part of the room
                }


                furniture.push({ html: `<g>
                        <rect x="${x}" y="${y}" width="${w}" height="${d}" fill="#f3f4f6" stroke="#9ca3af" stroke-width="0.5"/>
                        <text x="${x + w/2}" y="${y + d/2}" font-size="${8*scale}" text-anchor="middle" dominant-baseline="middle" fill="#1f2937">${getArabicName('coffee_table_title')}</text>
                    </g>` });
            }


            let furnitureHTML = furniture.map(f => f.html).join('');
            
            return `<svg width="600" viewBox="${viewBox}" xmlns="http://www.w3.org/2000/svg" class="mx-auto" style="overflow: visible; font-family: '${App.currentLang === 'ar' ? 'Cairo' : 'Inter'}', sans-serif;">
                ${defs}
                <rect x="0" y="0" width="${svgWidth}" height="${svgHeight}" fill="white" stroke="#94a3b8" stroke-width="1"/>
                <text x="${svgWidth/2}" y="-8" text-anchor="middle" font-size="12" fill="#475569">${T.room_size_label} ${roomW}x${roomH} cm</text>
                ${furnitureHTML}
            </svg>`;
        }

        function generateClosetVisualizerSVG(config) {
             if (!config || !config.includeCloset) return '';
            const T = App.config.LANGUAGES[App.currentLang];
            const cl = config.closet;
            const S = App.config.STORAGE_RATIOS;
            const ratio = S[cl.storageRatio] || S['balanced'];

            const totalWidth = cl.width;
            const totalHeight = cl.height;
            const numDoors = cl.doors > 0 ? cl.doors : 1;
            
            const svgWidth = 400;
            const svgHeight = (totalHeight / totalWidth) * svgWidth;

            const viewBox = `-40 -20 ${svgWidth + 80} ${svgHeight + 40}`; // Add padding for labels
            
            let innerHTML = '';

            // Draw main frame
            innerHTML += `<rect x="1" y="1" width="${svgWidth - 2}" height="${svgHeight - 2}" fill="#f1f5f9" stroke="#6366f1" stroke-width="1.5" />`;
            
            // Draw doors first
            const sectionWidth = (svgWidth - 2) / numDoors;
            for (let i = 0; i < numDoors; i++) {
                const xOffset = 1 + i * sectionWidth;
                const isGlass = i < cl.glassDoors;
                const doorFill = isGlass ? '#e0f2fe' : '#f1f5f9';

                innerHTML += `<rect x="${xOffset}" y="1" width="${sectionWidth}" height="${svgHeight - 2}" fill="${doorFill}" />`;
                
                if (isGlass) {
                    innerHTML += `<line x1="${xOffset + 5}" y1="${1 + 5}" x2="${xOffset + sectionWidth - 5}" y2="${svgHeight - 2 - 5}" stroke="#a5f3fc" stroke-width="1"/>`;
                    innerHTML += `<line x1="${xOffset + sectionWidth - 5}" y1="${1 + 5}" x2="${xOffset + 5}" y2="${svgHeight - 2 - 5}" stroke="#a5f3fc" stroke-width="1"/>`;
                }
            }


            // Internal structure logic
            let layout = [];
            if (ratio === S.mostly_hanging) {
                layout = ['hang', 'shelf', ...Array(Math.max(0, numDoors - 2)).fill('hang')];
            } else if (ratio === S.mostly_folding) {
                layout = ['shelf', 'shelf', ...Array(Math.max(0, numDoors - 2)).fill('shelf')];
            } else { // balanced
                const hangCount = Math.ceil(numDoors / 2);
                const shelfCount = numDoors - hangCount;
                layout = [...Array(hangCount).fill('hang'), ...Array(shelfCount).fill('shelf')];
            }

            for (let i = 0; i < numDoors; i++) {
                const xOffset = 1 + i * sectionWidth;
                
                // Draw vertical dividers (but not for the last door)
                if (i < numDoors - 1) {
                    innerHTML += `<line x1="${xOffset + sectionWidth}" y1="1" x2="${xOffset + sectionWidth}" y2="${svgHeight - 1}" stroke="#94a3b8" stroke-width="1" stroke-dasharray="4"/>`;
                }

                // Draw internal components
                if (layout[i % layout.length] === 'hang') {
                    // Hanging section: one shelf at top, one rod
                    innerHTML += `<line x1="${xOffset}" y1="${svgHeight * 0.1}" x2="${xOffset + sectionWidth}" y2="${svgHeight * 0.1}" stroke="#94a3b8" stroke-width="1"/>`; // Top shelf
                    innerHTML += `<line x1="${xOffset + sectionWidth * 0.1}" y1="${svgHeight * 0.15}" x2="${xOffset + sectionWidth * 0.9}" y2="${svgHeight * 0.15}" stroke="#64748b" stroke-width="2.5" stroke-linecap="round"/>`; // Hanging rod
                } else {
                    // Shelf section: multiple shelves
                    for(let j = 1; j < 5; j++) {
                        const yPos = svgHeight * (0.1 + j * 0.18);
                         innerHTML += `<line x1="${xOffset}" y1="${yPos}" x2="${xOffset + sectionWidth}" y2="${yPos}" stroke="#94a3b8" stroke-width="1"/>`;
                    }
                }
            }
            
            // Re-draw outer frame and door lines on top for crispness
            innerHTML += `<rect x="1" y="1" width="${svgWidth - 2}" height="${svgHeight - 2}" fill="none" stroke="#6366f1" stroke-width="1.5" />`;
            for (let i = 1; i < numDoors; i++) {
                const doorX = 1 + i * sectionWidth;
                innerHTML += `<line x1="${doorX}" y1="1" x2="${doorX}" y2="${svgHeight - 1}" stroke="#6366f1" stroke-width="1"/>`;
            }

            // Add dimensions
            innerHTML += `<defs>
                            <marker id="arrow" viewBox="0 -5 10 10" refX="5" refY="0" markerWidth="4" markerHeight="4" orient="auto"><path d="M0,-5L10,0L0,5" fill="#334155"></path></marker>
                         </defs>`;
            // Width dimension
            innerHTML += `<line x1="1" y1="${svgHeight + 15}" x2="${svgWidth-1}" y2="${svgHeight + 15}" stroke="#334155" stroke-width="1" marker-start="url(#arrow)" marker-end="url(#arrow)"/>`;
            innerHTML += `<text x="${svgWidth / 2}" y="${svgHeight + 28}" text-anchor="middle" font-size="12" fill="#334155">${totalWidth} cm</text>`;

            // Height dimension
            innerHTML += `<line x1="-15" y1="1" x2="-15" y2="${svgHeight-1}" stroke="#334155" stroke-width="1" marker-start="url(#arrow)" marker-end="url(#arrow)"/>`;
            innerHTML += `<text x="-28" y="${svgHeight / 2}" transform="rotate(-90 -28,${svgHeight/2})" text-anchor="middle" font-size="12" fill="#334155">${totalHeight} cm</text>`;

            // Title
            innerHTML += `<text x="${svgWidth/2}" y="-8" text-anchor="middle" font-size="14" font-weight="bold" fill="#312e81">${T.visualizer_closet}</text>`

            return `<svg width="500" viewBox="${viewBox}" xmlns="http://www.w3.org/2000/svg" class="mx-auto" style="overflow: visible; font-family: '${App.currentLang === 'ar' ? 'Cairo' : 'Inter'}', sans-serif;">
                ${innerHTML}
            </svg>`;
        }

        function generatePreviewPageHTML(config, total, deliveryWeeks) {
            const T = App.config.LANGUAGES[App.currentLang];
            const lang = App.currentLang;
            const dir = T.dir;
            const roundedTotal = Math.round(total);
            const summaryHTML = generateSummaryHTML(config);
            const layoutSVG = generateLayoutVisualizerSVG(config);
            const closetSVG = generateClosetVisualizerSVG(config);

            // This script will be embedded in the preview page to handle its functionality
            const previewPageScript = `
                <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"><\/script>
                <script>
                    async function handleShare() {
                        const shareBtn = document.getElementById('share-btn');
                        const originalText = shareBtn.innerHTML;
                        shareBtn.disabled = true;
                        shareBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block animate-spin -mt-1 mx-2 lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> ${T.generating_pdf}';

                        const content = document.getElementById('pdf-content');
                        const filename = 'Waleed Designs - ${new Date().toISOString().slice(0,10)}.pdf';

                        const pdfOptions = {
                            margin:       [0.2, 0.2, 0.2, 0.2], // Margins in inches [top, left, bottom, right]
                            filename:     filename,
                            image:        { type: 'jpeg', quality: 0.98 },
                            html2canvas:  { scale: 2, useCORS: true, letterRendering: true, windowWidth: 1400 }, // Force desktop-like render width
                            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }, // Reverted to A4
                            pagebreak:    { mode: 'css', before: '.page-break' } // Force page breaks
                        };
                        
                        try {
                            if (navigator.share && navigator.canShare) {
                                const pdfBlob = await html2pdf().from(content).set(pdfOptions).output('blob');
                                const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });
                                
                                if (navigator.canShare({ files: [pdfFile] })) {
                                    await navigator.share({
                                        files: [pdfFile],
                                        title: '${T.summary_title}',
                                        text: '${T.app_title}',
                                    });
                                } else {
                                    html2pdf().from(content).set(pdfOptions).save();
                                }
                            } else {
                                html2pdf().from(content).set(pdfOptions).save();
                            }
                        } catch (err) {
                             if (err.name !== 'AbortError') {
                                console.error('Share Error:', err);
                                alert('${T.share_error}');
                            }
                        } finally {
                            shareBtn.disabled = false;
                            shareBtn.innerHTML = originalText;
                        }
                    }
                <\/script>
            `;

            return `<!DOCTYPE html>
                <html lang="${lang}" dir="${dir}">
                <head>
                    <meta charset="UTF-8">
                    <title>${T.summary_title} - Waleed Designs</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: '${lang === 'ar' ? 'Cairo' : 'Inter'}', sans-serif; background-color: #e2e8f0; }
                        .pdf-page-container {
                            width: 21cm; /* A4 width */
                            height: 29.7cm; /* Strict height for A4 */
                            padding: 1cm;
                            margin: 1rem auto;
                            border-radius: 5px;
                            background: white;
                            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
                            box-sizing: border-box;
                            display: flex;
                            flex-direction: column;
                            overflow: hidden; /* Prevent content overflow from creating extra pages */
                        }
                        .page-break { page-break-after: always; }
                        .visualizer-wrapper {
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            width: 100%;
                            flex-grow: 1; /* Allow wrapper to fill available space */
                            overflow: hidden;
                            border: 1px solid #e2e8f0;
                            border-radius: 0.5rem;
                            background-color: #f8fafc;
                            padding: 1rem;
                            box-sizing: border-box;
                        }
                        .visualizer-wrapper svg {
                           width: 100%;
                           height: 100%;
                           object-fit: contain;
                        }
                        @media print {
                            body { background-color: white; margin: 0; }
                            .no-print { display: none !important; }
                            .pdf-page-container { margin: 0; box-shadow: none; border-radius: 0; border: none; }
                        }
                    </style>
                </head>
                <body class="bg-slate-200">
                    <div class="max-w-4xl mx-auto p-4 text-center no-print sticky top-0 z-10 bg-slate-200/80 backdrop-blur-sm">
                        <button onclick="window.close()" class="bg-slate-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-600 transition">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block -mt-1 mx-2 lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                            ${T.guide_back_button_text}
                        </button>
                        <button id="share-btn" onclick="handleShare()" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block -mt-1 mx-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            ${T.print_button_text}
                        </button>
                    </div>

                    <div id="pdf-content">
                        <!-- PAGE 1: SUMMARY -->
                        <div class="pdf-page-container">
                            <header class="text-center border-b-2 pb-4 mb-8">
                                <h1 class="text-4xl font-black text-indigo-800">Waleed Designs</h1>
                                <p class="text-xl text-slate-600 mt-2">${T.summary_title}</p>
                            </header>
                            <main>${summaryHTML}</main>
                            <footer class="mt-auto pt-8 border-t-2 text-center space-y-6">
                                 <div class="bg-indigo-50 border border-indigo-200 p-6 rounded-lg">
                                     <p class="text-lg font-bold text-slate-700">${T.footer_price_label}</p>
                                     <p class="text-4xl font-black text-indigo-700 my-2">${roundedTotal.toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')} ج.م</p>
                                     <p class="text-md font-bold text-green-700">${T.delivery_estimate_text} ${deliveryWeeks} ${T.delivery_weeks_unit}</p>
                                     <p class="text-xs text-slate-500 mt-3">${T.footer_disclaimer}</p>
                                 </div>
                                 <div>
                                     <p class="font-bold text-slate-800">${T.customer_service}: 01110846333 / 01220431043</p>
                                     <p class="text-slate-600">${T.facebook_page}: facebook.com/waleed.designs.furniture</p>
                                 </div>
                            </footer>
                        </div>
                        
                        ${layoutSVG ? `
                        <!-- PAGE 2: ROOM LAYOUT -->
                        <div class="pdf-page-container page-break">
                            <h2 class="text-2xl font-bold text-center text-indigo-800 mb-6 shrink-0">${T.visualizer_title}</h2>
                            <div class="visualizer-wrapper">
                                ${layoutSVG}
                            </div>
                        </div>` : ''}

                        ${closetSVG ? `
                        <!-- PAGE 3: CLOSET DETAILS -->
                        <div class="pdf-page-container page-break">
                            <h2 class="text-2xl font-bold text-center text-indigo-800 mb-6 shrink-0">${T.visualizer_closet_details_title}</h2>
                             <div class="visualizer-wrapper">
                                ${closetSVG}
                            </div>
                        </div>` : ''}
                    </div>
                    ${previewPageScript}
                </body>
                </html>`;
        }
        
        async function handleShareClick() {
            if (!validateForm()) {
                showAlert(t('validation_fix_fields'), t('validation_input_error'));
                return;
            }

            const T = App.config.LANGUAGES[App.currentLang];
            const originalButtonContent = App.elements.exportShareBtn.innerHTML;
            App.elements.exportShareBtn.disabled = true;
            const loadingSpan = App.elements.exportShareBtn.querySelector('span');
            if(loadingSpan) loadingSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block animate-spin -mt-1 mx-2 lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> ` + T.generating_pdf;

            try {
                const config = getFullConfiguration();
                const { total, error } = calculateTotal();
                if (error) {
                    showAlert(error, t('validation_specs_error'));
                    return;
                }
                const deliveryWeeks = calculateDeliveryEstimate(config);
                
                // Generate the full HTML for the preview page
                const previewHTML = generatePreviewPageHTML(config, total, deliveryWeeks);
                
                // Open a new window and write the content
                const previewWindow = window.open("", "_blank");
                if (previewWindow) {
                    previewWindow.document.open();
                    previewWindow.document.write(previewHTML);
                    previewWindow.document.close();
                } else {
                    showAlert(t('popup_blocker_alert'), t('modal_error'));
                }

            } catch (err) {
                console.error('Preview Generation Error:', err);
                showAlert(t('share_error'), t('modal_error'));
            } finally {
                App.elements.exportShareBtn.disabled = false;
                App.elements.exportShareBtn.innerHTML = originalButtonContent;
            }
        }
        
        // --- DATA PERSISTENCE (FIRESTORE) ---
        const debouncedSaveState = debounce(async () => {
            if (!App.auth || !App.currentUserId || !App.db) return;
            const state = getFullConfiguration();
            const docRef = doc(App.db, "artifacts", App.appId, "users", App.currentUserId, "designs", App.config.DESIGN_DOC_ID);
            try {
                await setDoc(docRef, state);
            } catch (e) {
                console.error("Error saving state to Firestore: ", e);
            }
        }, 1000);

        function loadState(state) {
            if (!state) return;

            Object.keys(state).forEach(key => {
                if (typeof state[key] === 'object' && state[key] !== null) {
                    Object.keys(state[key]).forEach(subKey => {
                        const elementId = `${key}-${subKey.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                        const element = $(`#${elementId}`);
                        if(element) {
                            if(element.type === 'checkbox') element.checked = state[key][subKey];
                            else element.value = state[key][subKey];
                        }
                    });
                } else {
                    const elementId = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                    const element = $(`#${elementId}`);
                    if(element) {
                         if(element.type === 'checkbox') element.checked = state[key];
                         else element.value = state[key];
                    }
                }
            });
            // Handle special cases
            if (state.closet && state.closet.mechanism) {
                setMechanismButtonState(state.closet.mechanism);
            }
            $$('input[type="checkbox"][data-card-id]').forEach(handleCardToggle);
            updateUI();
        }

        async function checkForSavedState() {
             if (!App.currentUserId || !App.db) {
                resetForm(true);
                return;
             }

            const docRef = doc(App.db, "artifacts", App.appId, "users", App.currentUserId, "designs", App.config.DESIGN_DOC_ID);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const savedState = docSnap.data();
                const modal = App.elements.restoreSessionModal;
                const content = modal.querySelector('.modal-content');
                modal.classList.remove('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-95', 'opacity-0');

                $('#restore-yes-btn').onclick = () => {
                    loadState(savedState);
                    content.classList.add('scale-95', 'opacity-0');
                    modal.classList.add('opacity-0', 'pointer-events-none');
                };
                $('#restore-no-btn').onclick = async () => {
                    await resetForm(false); // reset and delete doc
                    content.classList.add('scale-95', 'opacity-0');
                    modal.classList.add('opacity-0', 'pointer-events-none');
                };
            } else {
                resetForm(true); // Initial load without saved state
            }
        }
        
        // --- INITIALIZATION ---
        function initialize() {
            // Mapping elements
            App.elements = {
                configuratorForm: $('#configurator-form'),
                mainView: $('#main-view'),
                guideView: $('#guide-view'),
                showGuideBtn: $('#show-guide-btn'),
                resetFormBtn: $('#reset-form-btn'),
                exportShareBtn: $('#export-share-btn'),
                backToMainBtns: $$('.back-to-main-btn'),

                footer: $('footer'), totalPrice: $('#total-price'), priceErrorMessage: $('#price-error-message'), deliveryEstimate: $('#delivery-estimate'),
                priceBreakdown: $('#price-breakdown'),
                footerPromoMessage: $('#footer-promo-message'),
                requestQuoteBtn: $('#request-quote-btn'), showQuoteBtn: $('#show-quote-btn'), 
                langToggleButton: $('#lang-toggle-btn'), langIconEn: $('#icon-lang-en'), langIconAr: $('#icon-lang-ar'),
                customerName: $('#customer-name'), customerPhone: $('#customer-phone'), customerCity: $('#customer-city'),
                roomSize: $('#room-size'),
                additionalNotes: $('#additional-notes'),
                editModeMessage: $('#edit-mode-message'), hideQuoteLink: $('#hide-quote-link'), 
                requestAppointmentCheckbox: $('#request-appointment'),
                appointmentDateContainer: $('#appointment-date-container'),
                appointmentDateInput: $('#appointment-date'),

                // Closet
                includeCloset: $('#include-closet'), closetWoodType: $('#closet-wood-type'), closetPaintType: $('#closet-paint-type'), closetPaintOptionContainer: $('#closet-paint-option-container'), closetWidth: $('#closet-width'), closetHeight: $('#closet-height'), closetDepth: $('#closet-depth'), closetDoors: $('#closet-doors'), closetGlassDoors: $('#closet-glass-doors'), closetStorageRatio: $('#closet-storage-ratio'), doorMechanism: $('#door-mechanism'), closetLed: $('#closet-led'),
                closetSmartAlert: $('#closet-smart-alert'),
                
                // Bed & Komod
                includeBed: $('#include-bed'), bedCount: $('#bed-count'), bedSize: $('#bed-size'), bedMaterial: $('#bed-material'), bedPaintType: $('#bed-paint-type'), bedPaintOptionContainer: $('#bed-paint-option-container'), liftingMechanism: $('#lifting-mechanism'), bedLed: $('#bed-led'),
                komodCount: $('#komod-count'), komodDrawers: $('#komod-drawers'),
                bedSmartAlert: $('#bed-smart-alert'),
                
                // Dresser & Mirror
                includeDresser: $('#include-dresser'), dresserType: $('#dresser-type'), dresserDrawers: $('#dresser-drawers'), dresserWidth: $('#dresser-width'), dresserDepth: $('#dresser-depth'),
                mirrorShape: $('#mirror-shape'), mirrorWidth: $('#mirror-width'), mirrorHeight: $('#mirror-height'), mirrorLed: $('#mirror-led'),
                mirrorWidthLabel: $('#mirror-width-label'), mirrorHeightContainer: $('#mirror-height-container'),
                mirrorShapeIconRect: $('#icon-rectangle'), mirrorShapeIconSquare: $('#icon-square'), mirrorShapeIconCircle: $('#icon-circle'),

                // Additional Items
                includeTvTable: $('#include-tv-table'), tvTableWidth: $('#tv-table-width'), tvTableHeight: $('#tv-table-height'), tvTableDepth: $('#tv-table-depth'), tvTableDrawers: $('#tv-table-drawers'), tvTableDoors: $('#tv-table-doors'), tvTableType: $('#tv-table-type'),
                includeCoffeeTable: $('#include-coffee-table'), coffeeTableWidth: $('#coffee-table-width'), coffeeTableHeight: $('#coffee-table-height'), coffeeTableDepth: $('#coffee-table-depth'),
                includeLSofa: $('#include-l-sofa'), lSofaWidth: $('#l-sofa-width'), lSofaDepth: $('#l-sofa-depth'),
                includeSofa: $('#include-sofa'), sofaWidth: $('#sofa-width'),
                includeSofaBed: $('#include-sofa-bed'), sofaBedWidth: $('#sofa-bed-width'),
                
                // Modals
                alertModal: $('#alert-modal'), modalContent: $('#alert-modal .modal-content'), modalTitle: $('#modal-title'), modalMessage: $('#modal-message'), modalCloseBtn: $('#modal-close-btn'),
                restoreSessionModal: $('#restore-session-modal'),
            };

            // Add styles for new components dynamically
            const style = document.createElement('style');
            style.textContent = `
                .stepper-btn {
                    width: 2.5rem; height: 2.5rem; background-color: #f1f5f9; color: #475569;
                    border: 1px solid #cbd5e1; font-size: 1.5rem; line-height: 1; font-weight: bold;
                    cursor: pointer; transition: background-color 0.2s;
                    display: inline-flex; align-items: center; justify-content: center;
                }
                .stepper-btn:hover { background-color: #e2e8f0; }
                .stepper-btn:first-of-type { border-radius: 0 0.375rem 0.375rem 0; }
                .stepper-btn:last-of-type { border-radius: 0.375rem 0 0 0.375rem; }
                body[dir="ltr"] .stepper-btn:first-of-type { border-radius: 0.375rem 0 0 0.375rem; }
                body[dir="ltr"] .stepper-btn:last-of-type { border-radius: 0 0.375rem 0.375rem 0; }

                .smart-alert {
                    background-color: #fefce8; color: #a16207; border: 1px solid #fde047;
                    padding: 0.5rem; border-radius: 0.375rem; font-size: 0.8rem; margin-top: 0.5rem;
                }
            `;
            document.head.appendChild(style);

            // --- Event listeners setup ---
            App.elements.langToggleButton.addEventListener('click', toggleLanguage);
            App.elements.resetFormBtn.addEventListener('click', () => resetForm(false));
            App.elements.exportShareBtn.addEventListener('click', handleShareClick);
            
            handleMechanismButtons();
            handleStepperButtons();

            $$('#configurator-form select, #configurator-form input[type="checkbox"]').forEach(el => el.addEventListener('change', updateUI));
            
            // For text inputs (like customer name/phone), only run debounced recalculate to check button state.
            $$('#configurator-form input[type="text"], #configurator-form input[type="tel"]').forEach(el => el.addEventListener('input', updateUI));
            
            // For number inputs, combine validation and recalculation.
            $$('#configurator-form input[type="number"]').forEach(el => {
                el.addEventListener('input', () => {
                    validateInput(el); // Validate on every input
                    debouncedRecalculate(); // Recalculate price after a short delay
                });
            });
            
            App.elements.configuratorForm.addEventListener('input', debouncedSaveState);
            
            App.elements.additionalNotes.addEventListener('input', () => {
                const el = App.elements.additionalNotes;
                el.style.height = 'auto';
                el.style.height = (el.scrollHeight) + 'px';
            });

            App.elements.closetWidth.addEventListener('input', () => {
                const width = parseFloat(App.elements.closetWidth.value);
                if (width > 0) {
                    App.elements.closetDoors.value = Math.max(1, Math.round(width / 50));
                }
            });

            App.elements.bedCount.addEventListener('input', () => {
                const bedCount = parseInt(App.elements.bedCount.value, 10);
                if (bedCount === 1) App.elements.komodCount.value = 2;
                else if (bedCount === 2) App.elements.komodCount.value = 1;
            });

            App.elements.closetPaintType.addEventListener('change', (e) => {
                if (App.elements.bedMaterial.value === 'wood') {
                    App.elements.bedPaintType.value = e.target.value;
                }
            });

            $$('input[type="checkbox"][data-card-id]').forEach(checkbox => {
                checkbox.addEventListener('change', () => handleCardToggle(checkbox));
            });
            
            App.elements.roomSize.addEventListener('change', updateDimensionsBasedOnSize);
            App.elements.showQuoteBtn.addEventListener('click', showQuoteFooter);
            App.elements.requestQuoteBtn.addEventListener('click', submitQuote);
            App.elements.hideQuoteLink.addEventListener('click', hideQuoteFooter); 
            App.elements.showGuideBtn.addEventListener('click', () => {
                App.elements.mainView.classList.add('hidden');
                App.elements.guideView.classList.remove('hidden');
            });
            App.elements.backToMainBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    App.elements.guideView.classList.add('hidden');
                    App.elements.mainView.classList.remove('hidden');
                });
            });

            
            $$('#customer-name, #customer-phone, #customer-city').forEach(el => el.addEventListener('input', updateUI)); 
            
            App.elements.modalCloseBtn.addEventListener('click', hideAlert);
            App.elements.alertModal.addEventListener('click', e => { if (e.target === App.elements.alertModal) hideAlert(); });
            
            App.elements.requestAppointmentCheckbox.addEventListener('change', (e) => {
                App.elements.appointmentDateContainer.classList.toggle('hidden', !e.target.checked);
                if(e.target.checked) {
                    // Set min date to tomorrow
                    const today = new Date();
                    today.setDate(today.getDate() + 1);
                    App.elements.appointmentDateInput.min = today.toISOString().split('T')[0];
                    App.elements.appointmentDateInput.value = today.toISOString().split('T')[0];
                }
            });

            // --- Firebase Init ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : null;
            if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                try {
                    const app = initializeApp(firebaseConfig);
                    App.auth = getAuth(app);
                    App.db = getFirestore(app);
                    setLogLevel('debug'); // Enable Firestore debug logging
                    onAuthStateChanged(App.auth, async (user) => {
                        if (user) { 
                            App.currentUserId = user.uid; 
                        } else {
                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            try {
                                const signedInUser = initialAuthToken ? await signInWithCustomToken(App.auth, initialAuthToken) : await signInAnonymously(App.auth);
                                App.currentUserId = signedInUser.user.uid;
                            } catch (authError) {
                                console.error("Firebase Auth failed:", authError);
                                App.currentUserId = crypto.randomUUID(); 
                            }
                        }
                        // Now that we have a user ID, check for saved state
                        await checkForSavedState();
                    });
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    App.currentUserId = crypto.randomUUID();
                    resetForm(true); // Start fresh if firebase fails
                }
            } else {
                 console.warn("Firebase configuration not found. Using ephemeral session.");
                 App.currentUserId = crypto.randomUUID(); 
                 resetForm(true); // Start fresh if no firebase config
            }

            // Load saved language or default to Arabic
            const savedLang = localStorage.getItem('appLang') || 'ar';
            updateLanguage(savedLang);
        }
        
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>














